{% extends 'main/base.html' %} {% load static i18n %}
<!-- prettier-ignore -->
{% block title %}{% trans "Admin Dashboard - AWFERLK Solutions" %}{% endblock %}

{% block content %}
<div class="dashboard-container">
  <!-- Dashboard Header -->
  <div class="dashboard-header mb-4" data-aos="fade-down">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="display-5 fw-bold dashboard-title mb-2">
          <i class="fas fa-tachometer-alt me-3 text-primary"></i>
          {% trans "Admin Dashboard" %}
        </h1>
        <p class="text-muted">
          {% trans "Manage products, inquiries, messages, and branches" %}
        </p>
      </div>
      <div class="col-md-4 text-md-end">
        <div class="d-flex flex-wrap gap-2 justify-content-md-end">
          <button
            class="btn btn-primary-modern btn-modern"
            data-bs-toggle="modal"
            data-bs-target="#addProductModal"
          >
            <i class="fas fa-plus me-2"></i>
            {% trans "Add Product" %}
          </button>
          <button
            class="btn btn-success-modern btn-modern"
            data-bs-toggle="modal"
            data-bs-target="#addBranchModal"
          >
            <i class="fas fa-map-marker-alt me-2"></i>
            {% trans "Add Branch" %}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="row g-4 mb-5">
    <div class="col-xl-3 col-md-6" data-aos="fade-up" data-aos-delay="100">
      <div class="stats-card bg-primary text-white">
        <div class="stats-icon">
          <i class="fas fa-box"></i>
        </div>
        <div class="stats-content">
          <h3 class="stats-number">{{ products|length }}</h3>
          <p class="stats-label">{% trans "Total Products" %}</p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6" data-aos="fade-up" data-aos-delay="200">
      <div class="stats-card bg-success text-white">
        <div class="stats-icon">
          <i class="fas fa-question-circle"></i>
        </div>
        <div class="stats-content">
          <h3 class="stats-number">{{ invoices|length }}</h3>
          <p class="stats-label">{% trans "Product Inquiries" %}</p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6" data-aos="fade-up" data-aos-delay="300">
      <div class="stats-card bg-warning text-white">
        <div class="stats-icon">
          <i class="fas fa-envelope"></i>
        </div>
        <div class="stats-content">
          <h3 class="stats-number">{{ messages|length }}</h3>
          <p class="stats-label">{% trans "Messages" %}</p>
        </div>
      </div>
    </div>
    <div class="col-xl-3 col-md-6" data-aos="fade-up" data-aos-delay="400">
      <div class="stats-card bg-info text-white">
        <div class="stats-icon">
          <i class="fas fa-code-branch"></i>
        </div>
        <div class="stats-content">
          <h3 class="stats-number">{{ branches|length }}</h3>
          <p class="stats-label">{% trans "Branches" %}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Categories Section -->
  <div class="dashboard-section mb-5" data-aos="fade-up" data-aos-delay="300">
    <div
      class="section-header d-flex justify-content-between align-items-center mb-4"
    >
      <h3 class="section-title">
        <i class="fas fa-tags me-2 text-warning"></i>
        {% trans "Services" %}
      </h3>
      <button
        class="btn btn-success-modern btn-sm"
        data-bs-toggle="modal"
        data-bs-target="#addCategoryModal"
      >
        <i class="fas fa-plus me-1"></i>
        {% trans "Add Service" %}
      </button>
    </div>

    <div class="modern-card">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>{% trans "Image" %}</th>
              <th>{% trans "Name" %}</th>
              <th>{% trans "Description" %}</th>
              <th>{% trans "Actions" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for category in categories %}
            <tr>
              <td>
                {% if category.image %}
                <img
                  src="{{ category.image.url }}"
                  alt="{{ category.name }}"
                  class="rounded"
                  style="height: 50px; width: 50px; object-fit: cover"
                />
                {% else %}
                <div
                  class="no-image-placeholder d-flex justify-content-center align-items-center rounded bg-light"
                  style="height: 50px; width: 50px"
                >
                  <i class="fas fa-image text-muted"></i>
                </div>
                {% endif %}
              </td>
              <td>{{ category.name }}</td>
              <td>
                <span
                  class="text-truncate d-inline-block"
                  style="max-width: 200px"
                  title="{{ category.description }}"
                >
                  {{ category.description }}
                </span>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <!-- prettier-ignore -->
                  <button
                    class="btn btn-outline-primary edit-category-btn mx-1"
                    title="{% trans 'Edit' %}"
                    data-category-id="{{ category.id }}"
                    data-category-name="{{ category.name }}"
                    data-category-description="{{ category.description }}"
                    {% if category.image and category.image.name %}
                      data-category-image="{{ category.image.url }}"
                    {% else %}
                      data-category-image=""
                    {% endif %}
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-danger delete-category-btn mx-1"
                    title="{% trans 'Delete' %}"
                    data-category-id="{{ category.id }}"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="text-center py-4">
                <i class="fas fa-tags fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">
                  {% trans "No categories added yet" %}
                </p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Brands Section -->
  <div class="dashboard-section mb-5" data-aos="fade-up" data-aos-delay="300">
    <div
      class="section-header d-flex justify-content-between align-items-center mb-4"
    >
      <h3 class="section-title">
        <i class="fas fa-industry me-2 text-info"></i>
        {% trans "Technologies" %}
      </h3>
      <button
        class="btn btn-success-modern btn-sm"
        data-bs-toggle="modal"
        data-bs-target="#addBrandModal"
      >
        <i class="fas fa-plus me-1"></i>
        {% trans "Add Technology" %}
      </button>
    </div>

    <div class="modern-card">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>{% trans "Image" %}</th>
              <th>{% trans "Name" %}</th>
              <th>{% trans "Description" %}</th>
              <th>{% trans "Actions" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for brand in brands %}
            <tr>
              <td>
                {% if brand.image %}
                <img
                  src="{{ brand.image.url }}"
                  alt="{{ brand.name }}"
                  class="rounded"
                  style="height: 50px; width: 50px; object-fit: cover"
                />
                {% else %}
                <div
                  class="no-image-placeholder d-flex justify-content-center align-items-center rounded bg-light"
                  style="height: 50px; width: 50px"
                >
                  <i class="fas fa-image text-muted"></i>
                </div>
                {% endif %}
              </td>
              <td>{{ brand.name }}</td>
              <td>
                <span
                  class="text-truncate d-inline-block"
                  style="max-width: 200px"
                  title="{{ brand.description }}"
                >
                  {{ brand.description }}
                </span>
              </td>
              <td>
                <!-- prettier-ignore -->
                <div class="btn-group btn-group-sm">
                  <button
                    class="btn btn-outline-primary edit-brand-btn mx-1"
                    title="{% trans 'Edit' %}"
                    data-brand-id="{{ brand.id }}"
                    data-brand-name="{{ brand.name }}"
                    data-brand-description="{{ brand.description }}"
                    {% if brand.image and brand.image.name %}
                    data-brand-image="{{ brand.image.url }}"
                    {% else %}
                    data-brand-image=""
                    {% endif %}
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-danger delete-brand-btn mx-1"
                    title="{% trans 'Delete' %}"
                    data-brand-id="{{ brand.id }}"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="text-center py-4">
                <i class="fas fa-industry fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">{% trans "No brands added yet" %}</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Projects Section -->
  <div
    class="dashboard-section mb-5"
    id="projectsSection"
    data-aos="fade-up"
    data-aos-delay="400"
  >
    <div
      class="section-header d-flex justify-content-between align-items-center mb-4"
    >
      <h3 class="section-title">
        <i class="fas fa-folder-open me-2 text-primary"></i>
        {% trans "Projects" %}
      </h3>

      <button
        type="button"
        class="btn btn-success-modern btn-sm"
        id="btnOpenCreateProject"
        data-bs-toggle="modal"
        data-bs-target="#projectModal"
      >
        <i class="fas fa-plus me-1"></i>
        {% trans "Add Project" %}
      </button>
    </div>

    <div class="modern-card p-3 p-md-4">
      <!-- prettier-ignore -->
      <p class="text-muted mb-3">
        {% trans "Manage SITEX projects (create, edit, delete) and showcase them to clients." %}
      </p>

      <!-- Alerts -->
      <div id="projectsAlert" class="mb-3" style="display: none"></div>

      <!-- Grid -->
      <div class="row g-4" id="projectsGrid">
        <!-- Filled by JS -->
      </div>
    </div>
  </div>
  <!-- Invoices Section -->
  <div class="dashboard-section mb-5" data-aos="fade-up" data-aos-delay="300">
    <div
      class="section-header d-flex justify-content-between align-items-center mb-4"
    >
      <h3 class="section-title">
        <i class="fas fa-file-invoice-dollar me-2 text-warning"></i>
        {% trans "Invoices" %}
      </h3>
    </div>

    <div class="modern-card">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>{% trans "Invoice ID" %}</th>
              <th>{% trans "Name" %}</th>
              <th>{% trans "City / Address" %}</th>
              <th>{% trans "Phone" %}</th>
              <th>{% trans "Subtotal" %}</th>
              <th>{% trans "Delivery Fee" %}</th>
              <th>{% trans "Total" %}</th>
              <th>{% trans "Items" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for invoice in invoices %}
            <tr>
              <td>#{{ invoice.id }}</td>
              <td>{{ invoice.name|default:"Guest" }}</td>
              <td>
                <div>{{ invoice.city }}</div>
                <small class="text-muted">{{ invoice.address }}</small>
              </td>
              <td>{{ invoice.phone }}</td>
              <td>${{ invoice.subtotal }}</td>
              <!-- prettier-ignore -->
              <td>
                {% if invoice.delivery_fee %} د.ل{{ invoice.delivery_fee }} {% else %} د.ل0.00 {% endif %}
              </td>
              <td><strong>د.ل{{ invoice.total }}</strong></td>
              <td>
                <button
                  class="btn btn-sm btn-outline-primary"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#invoiceItems{{ invoice.id }}"
                  aria-expanded="false"
                  aria-controls="invoiceItems{{ invoice.id }}"
                >
                  {% trans "View Items" %}
                </button>
                <button
                  class="btn btn-sm btn-outline-success ms-2"
                  onclick="printInvoice({{ invoice.id }})"
                >
                  {% trans "Print" %}
                </button>
              </td>
            </tr>

            <tr class="collapse" id="invoiceItems{{ invoice.id }}">
              <td colspan="8">
                <div class="table-responsive">
                  <table class="table table-sm table-bordered mb-0">
                    <thead class="table-light">
                      <tr>
                        <th>{% trans "Product" %}</th>
                        <th>{% trans "Product ID" %}</th>
                        <th>{% trans "Quantity" %}</th>
                        <th>{% trans "Price (Original)" %}</th>
                        <th>{% trans "Discount (%)" %}</th>
                        <th>{% trans "Price After Discount" %}</th>
                        <th>{% trans "Subtotal" %}</th>
                      </tr>
                    </thead>

                    <tbody>
                      {% for item in invoice.items.all %}
                      <tr>
                        <td>{{ item.name|default:"-" }}</td>
                        <td>{{ item.product_id }}</td>
                        <td>{{ item.quantity }}</td>

                        {# Original price per unit #}
                        <!-- prettier-ignore -->
                        <td>
                          د.ل{{ item.original_price }}
                        </td>

                        {# Discount % #}
                        <!-- prettier-ignore -->
                        <td>
                          {% if item.discount_percentage %}
                          {{ item.discount_percentage }}%
                          {% else %}
                           0%
                          {% endif %}
                        </td>
                        <!-- prettier-ignore -->
                        {# Discounted price per unit (already stored in item.price) #}
                        <td>د.ل{{ item.price }}</td>

                        {# Discounted subtotal #}
                        <td>د.ل{{ item.subtotal }}</td>
                      </tr>
                      {% empty %}
                      <tr>
                        <td colspan="7" class="text-center text-muted">
                          {% trans "No items in this invoice." %}
                        </td>
                      </tr>
                      {% endfor %} {# Delivery line #}
                      <!-- prettier-ignore -->
                      {% if invoice.delivery_fee and invoice.delivery_fee|floatformat:2 != '0.00' %}
                      <tr class="table-warning">
                        <td>{% trans "Delivery price" %}</td>
                        <td>—</td>
                        <td>1</td>
                        <td>د.ل{{ invoice.delivery_fee }}</td>
                        <td>0%</td>
                        <td>د.ل{{ invoice.delivery_fee }}</td>
                        <td>د.ل{{ invoice.delivery_fee }}</td>
                      </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center py-4">
                <i class="fas fa-file-invoice-dollar fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">
                  {% trans "No invoices created yet" %}
                </p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Products Section -->
  <div class="dashboard-section mb-5" data-aos="fade-up">
    <div
      class="section-header d-flex justify-content-between align-items-center mb-4"
    >
      <h3 class="section-title">
        <i class="fas fa-box me-2 text-primary"></i>
        {% trans "Products" %}
      </h3>
      <button
        class="btn btn-primary-modern btn-sm"
        data-bs-toggle="modal"
        data-bs-target="#addProductModal"
      >
        <i class="fas fa-plus me-1"></i>
        {% trans "Add Product" %}
      </button>
    </div>
    <div class="modern-card">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>{% trans "Product" %}</th>
              <th>{% trans "Image" %}</th>
              <th>{% trans "Available" %}</th>
              <th>{% trans "Price" %}</th>
              <th>{% trans "Discount (%)" %}</th>
              <th>{% trans "Actions" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for product in products %}
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <div class="product-info">
                    <h6 class="mb-0 fw-semibold">{{ product.name }}</h6>
                    <small class="text-muted">
                      {{ product.description|truncatewords:10 }}
                    </small>
                  </div>
                </div>
              </td>
              <td>
                {% if product.image %}
                <img
                  src="{{ product.image.url }}"
                  alt="{{ product.name }}"
                  class="product-thumbnail"
                />
                {% else %}
                <div class="no-image-placeholder">
                  <i class="fas fa-image text-muted"></i>
                </div>
                {% endif %}
              </td>
              <td>
                <span
                  class="badge {% if product.quantity_available > 10 %}bg-success{% else %}bg-warning{% endif %}"
                >
                  {{ product.quantity_available }}
                </span>
              </td>
              <td>
                <span class="fw-semibold text-primary"
                  >د.ل{{ product.price|default:"0.00" }}</span
                >
              </td>
              <td>
                <span class="fw-semibold text-primary"
                  >د.ل{{ product.discount_percentage|default:"0" }}</span
                >
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button
                    type="button"
                    class="btn btn-outline-primary edit-product-btn mx-1"
                    title="{% trans 'Edit' %}"
                    data-product-id="{{ product.id }}"
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button
                    type="button"
                    class="btn btn-outline-danger delete-product-btn mx-1"
                    title="{% trans 'Delete' %}"
                    data-product-id="{{ product.id }}"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center py-4">
                <i class="fas fa-box-open fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">
                  {% trans "No products available" %}
                </p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <div class="dashboard-section mb-5" data-aos="fade-up">
    <div
      class="section-header d-flex justify-content-between align-items-center mb-4"
    >
      <h3 class="section-title">
        <i class="fas fa-images me-2 text-primary"></i>
        {% trans "Banners" %}
      </h3>
      <button
        class="btn btn-primary-modern btn-sm"
        data-bs-toggle="modal"
        data-bs-target="#addBannerModal"
      >
        <i class="fas fa-plus me-1"></i>
        {% trans "Add Banner" %}
      </button>
    </div>

    <div class="modern-card">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>{% trans "Title" %}</th>
              <th>{% trans "Image" %}</th>
              <th>{% trans "Order" %}</th>
              <th>{% trans "Active" %}</th>
              <th>{% trans "Actions" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for banner in banners %}
            <tr>
              <td>{{ banner.title }}</td>

              <td>
                {% if banner.image %}
                <img src="{{ banner.image.url }}" class="product-thumbnail" />
                {% else %}
                <div class="no-image-placeholder">
                  <i class="fas fa-image text-muted"></i>
                </div>
                {% endif %}
              </td>

              <td>{{ banner.order }}</td>

              <td>
                <span
                  class="badge {% if banner.is_active %}bg-success{% else %}bg-danger{% endif %}"
                >
                  {{ banner.is_active|yesno:"Active,Inactive" }}
                </span>
              </td>

              <td>
                <div class="btn-group btn-group-sm">
                  <button
                    class="btn btn-outline-primary edit-banner-btn mx-1"
                    data-banner-id="{{ banner.id }}"
                  >
                    <i class="fas fa-edit"></i>
                  </button>

                  <button
                    class="btn btn-outline-danger delete-banner-btn mx-1"
                    data-banner-id="{{ banner.id }}"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center py-4">
                <i class="fas fa-images fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">
                  {% trans "No banners available" %}
                </p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Messages Section -->
  <div class="dashboard-section mb-5" data-aos="fade-up" data-aos-delay="200">
    <div class="section-header mb-4">
      <h3 class="section-title">
        <i class="fas fa-envelope me-2 text-warning"></i>
        {% trans "Messages" %}
      </h3>
    </div>
    <div class="modern-card">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>{% trans "Email" %}</th>
              <th>{% trans "Message" %}</th>
              <th>{% trans "Date" %}</th>
              <th>{% trans "Actions" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for message in messages %}
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <div
                    class="user-avatar bg-info text-white rounded-circle me-2"
                  >
                    {{ message.email|first|upper }}
                  </div>
                  <span class="fw-semibold">{{ message.email }}</span>
                </div>
              </td>
              <td>
                <span
                  class="text-truncate d-inline-block"
                  style="max-width: 200px"
                  title="{{ message.message }}"
                  >{{ message.message }}</span
                >
              </td>
              <td>
                <small class="text-muted"
                  >{{ message.created_at|date:"M d, Y" }}</small
                >
              </td>
              <td>
                <button
                  class="btn btn-outline-primary btn-sm"
                  title="{% trans 'View' %}"
                  data-bs-toggle="modal"
                  data-bs-target="#viewMessageModal"
                  data-message="{{ message.message }}"
                  data-email="{{ message.email }}"
                >
                  <i class="fas fa-eye"></i>
                </button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="4" class="text-center py-4">
                <i class="fas fa-comments fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">{% trans "No messages yet" %}</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Branches Section -->
  <div class="dashboard-section mb-5" data-aos="fade-up" data-aos-delay="300">
    <div
      class="section-header d-flex justify-content-between align-items-center mb-4"
    >
      <h3 class="section-title">
        <i class="fas fa-code-branch me-2 text-info"></i>
        {% trans "Branches" %}
      </h3>
      <button
        class="btn btn-success-modern btn-sm"
        data-bs-toggle="modal"
        data-bs-target="#addBranchModal"
      >
        <i class="fas fa-plus me-1"></i>
        {% trans "Add Branch" %}
      </button>
    </div>
    <div class="modern-card">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>{% trans "Name" %}</th>
              <th>{% trans "Address" %}</th>
              <th>{% trans "Coordinates" %}</th>
              <th>{% trans "Primary" %}</th>
              <th>{% trans "Actions" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for branch in branches %}
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <i class="fas fa-map-marker-alt text-danger me-2"></i>
                  <span class="fw-semibold">{{ branch.name }}</span>
                </div>
              </td>
              <td>
                <span
                  class="text-truncate d-inline-block"
                  style="max-width: 200px"
                  title="{{ branch.address }}"
                  >{{ branch.address }}</span
                >
              </td>
              <td>
                <!-- prettier-ignore -->
                <small class="text-muted">
                  {% if branch.latitude is not None %}
                  {{ branch.latitude|floatformat:2 }}
                  {% else %}
                  {% trans "Not Set" %}
                  {% endif %},
                  {% if branch.longitude is not None %}
                  {{ branch.longitude|floatformat:2 }}
                  {% else %}
                  {% trans "Not Set" %}
                  {% endif %}
                </small>
              </td>
              <td>
                {% if branch.primery_branch %}
                <span class="badge bg-success">{% trans "Yes" %}</span>
                {% else %}
                <span class="badge bg-secondary">{% trans "No" %}</span>
                {% endif %}
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button
                    class="btn btn-outline-primary edit-branch-btn mx-1"
                    title="{% trans 'Edit' %}"
                    data-branch-id="{{ branch.id }}"
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button
                    class="btn btn-outline-danger delete-branch-btn mx-1"
                    title="{% trans 'Delete' %}"
                    data-branch-id="{{ branch.id }}"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="5" class="text-center py-4">
                <i class="fas fa-store-alt fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">
                  {% trans "No branches added yet" %}
                </p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  <!-- Cities Section -->
  <div class="dashboard-section mb-5" data-aos="fade-up" data-aos-delay="350">
    <div
      class="section-header d-flex justify-content-between align-items-center mb-4"
    >
      <h3 class="section-title">
        <i class="fas fa-city me-2 text-secondary"></i>
        {% trans "Cities" %}
      </h3>
      <button
        class="btn btn-success-modern btn-sm"
        data-bs-toggle="modal"
        data-bs-target="#addCityModal"
      >
        <i class="fas fa-plus me-1"></i>
        {% trans "Add City" %}
      </button>
    </div>

    <div class="modern-card">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>{% trans "City Name" %}</th>
              <th>{% trans "Delivery Fee" %}</th>
              <th>{% trans "Actions" %}</th>
            </tr>
          </thead>
          <tbody>
            {% for city in cities %}
            <tr>
              <td>
                <div class="d-flex align-items-center">
                  <i class="fas fa-map-marker-alt text-primary me-2"></i>
                  <span class="fw-semibold">{{ city.name }}</span>
                </div>
              </td>
              <td>
                <span class="fw-semibold text-primary">
                  {{ city.delivery_fee }} د.ل
                </span>
              </td>
              <td>
                <div class="btn-group btn-group-sm">
                  <button
                    class="btn btn-outline-primary edit-city-btn mx-1"
                    title="{% trans 'Edit' %}"
                    data-city-id="{{ city.id }}"
                    data-city-name="{{ city.name }}"
                    data-city-fee="{{ city.delivery_fee }}"
                  >
                    <i class="fas fa-edit"></i>
                  </button>
                  <button
                    class="btn btn-outline-danger delete-city-btn mx-1"
                    title="{% trans 'Delete' %}"
                    data-city-id="{{ city.id }}"
                  >
                    <i class="fas fa-trash"></i>
                  </button>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="3" class="text-center py-4">
                <i class="fas fa-city fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-0">{% trans "No cities added yet" %}</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Create/Edit -->
<div class="modal fade" id="projectModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content modern-card" style="border-radius: 16px">
      <div class="modal-header">
        <h5 class="modal-title fw-bold" id="projectModalTitle">
          {% trans "Add Project" %}
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>

      <form id="projectForm">
        {% csrf_token %}
        <div class="modal-body">
          <input type="hidden" id="projectId" />

          <div class="row g-3">
            <div class="col-md-8">
              <label class="form-label">{% trans "Title" %}</label>
              <input
                class="form-control form-control-modern"
                id="title"
                required
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">{% trans "Year" %}</label>
              <input
                type="number"
                class="form-control form-control-modern"
                id="year"
                min="1990"
                max="2100"
              />
            </div>

            <div class="col-md-4">
              <label class="form-label">{% trans "Project Type" %}</label>
              <input
                class="form-control form-control-modern"
                id="project_type"
                placeholder="Website, System, Integration..."
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">{% trans "Industry" %}</label>
              <input
                class="form-control form-control-modern"
                id="industry"
                placeholder="Banking, Retail..."
              />
            </div>
            <div class="col-md-4">
              <label class="form-label">{% trans "Sort Order" %}</label>
              <input
                type="number"
                class="form-control form-control-modern"
                id="sort_order"
                min="0"
                value="0"
              />
            </div>

            <div class="col-12">
              <label class="form-label">{% trans "Tech Stack" %}</label>
              <input
                class="form-control form-control-modern"
                id="stack"
                placeholder="Django, DRF, React, Docker..."
              />
            </div>

            <div class="col-12">
              <label class="form-label">{% trans "Project URL" %}</label>
              <input
                type="url"
                class="form-control form-control-modern"
                id="url"
                placeholder="https://..."
              />
            </div>

            <div class="col-12">
              <label class="form-label">{% trans "Description" %}</label>
              <textarea
                class="form-control form-control-modern"
                id="description"
                rows="4"
              ></textarea>
            </div>

            <div class="col-md-6">
              <label class="form-label">{% trans "Image" %}</label>
              <input
                type="file"
                class="form-control form-control-modern"
                id="image"
                accept="image/*"
              />
              <small class="text-muted d-block mt-1"
                >{% trans "Leave empty to keep current image when editing."
                %}</small
              >
            </div>

            <div class="col-md-3 d-flex align-items-center">
              <div class="form-check mt-4">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="is_featured"
                />
                <label class="form-check-label" for="is_featured"
                  >{% trans "Featured" %}</label
                >
              </div>
            </div>

            <div class="col-md-3 d-flex align-items-center">
              <div class="form-check mt-4">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="is_public"
                  checked
                />
                <label class="form-check-label" for="is_public"
                  >{% trans "Public" %}</label
                >
              </div>
            </div>
          </div>

          <div class="text-danger small mt-3" id="projectFormErrors"></div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-outline-secondary btn-modern"
            data-bs-dismiss="modal"
          >
            {% trans "Cancel" %}
          </button>
          <button
            type="submit"
            class="btn btn-primary-modern btn-modern"
            id="projectSubmitBtn"
          >
            <i class="fas fa-save me-2"></i>{% trans "Save" %}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal: Delete confirm -->
<div
  class="modal fade"
  id="deleteProjectModal"
  tabindex="-1"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modern-card" style="border-radius: 16px">
      <div class="modal-header">
        <h5 class="modal-title fw-bold">{% trans "Delete Project" %}</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <p class="mb-0">
          {% trans "Are you sure you want to delete this project?" %}
        </p>
        <input type="hidden" id="deleteProjectId" />
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary btn-modern"
          data-bs-dismiss="modal"
        >
          {% trans "Cancel" %}
        </button>
        <button
          type="button"
          class="btn btn-danger btn-modern"
          id="confirmDeleteProjectBtn"
        >
          <i class="fas fa-trash me-2"></i>{% trans "Delete" %}
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Add Product Modal -->
<div
  class="modal fade"
  id="addProductModal"
  tabindex="-1"
  aria-labelledby="addProductModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content modern-modal">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="addProductModalLabel">
          <i class="fas fa-plus-circle me-2"></i>
          {% trans "Add New Product" %}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body p-3 p-md-4">
        <form id="productFormAdd" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="row g-3">
            <!-- Name -->
            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  id="productNameAdd"
                  name="name"
                  placeholder="{% trans 'Product Name' %}"
                  required
                />
                <label for="productNameAdd">{% trans "Product Name" %}</label>
              </div>
            </div>

            <!-- Price -->
            <div class="col-md-3">
              <div class="form-floating">
                <input
                  type="number"
                  class="form-control"
                  id="productPriceAdd"
                  name="price"
                  placeholder="{% trans 'Price' %}"
                  step="0.01"
                  required
                />
                <label for="productPriceAdd">{% trans "Price (د.ل)" %}</label>
              </div>
            </div>

            <!-- Discount Percentage -->
            <div class="col-md-3">
              <div class="form-floating">
                <input
                  type="number"
                  class="form-control"
                  id="productDiscountAdd"
                  name="discount_percentage"
                  placeholder="{% trans 'Discount %' %}"
                  step="0.01"
                  min="0"
                  max="100"
                />
                <label for="productDiscountAdd"
                  >{% trans "Discount (%)" %}</label
                >
              </div>
            </div>

            <!-- Description -->
            <div class="col-12">
              <div class="form-floating">
                <textarea
                  class="form-control"
                  id="productDescriptionAdd"
                  name="description"
                  placeholder="{% trans 'Description' %}"
                  style="height: 100px"
                  required
                ></textarea>
                <label for="productDescriptionAdd">
                  {% trans "Description" %}
                </label>
              </div>
            </div>

            <!-- Quantity -->
            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="number"
                  class="form-control"
                  id="productQuantityAdd"
                  name="quantity_available"
                  placeholder="{% trans 'Quantity Available' %}"
                  required
                />
                <label for="productQuantityAdd">
                  {% trans "Quantity Available" %}
                </label>
              </div>
            </div>

            <!-- Category -->
            <div class="col-md-6">
              <div class="form-floating">
                <select
                  class="form-select"
                  id="productCategoryAdd"
                  name="category"
                  required
                >
                  <option value="">{% trans "Select Category" %}</option>
                  {% for category in categories %}
                  <option value="{{ category.id }}">{{ category.name }}</option>
                  {% endfor %}
                </select>
                <label for="productCategoryAdd">{% trans "Category" %}</label>
              </div>
            </div>

            <!-- Flags -->
            <div class="col-md-4">
              <div class="form-check p-3 border rounded">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="showPriceAdd"
                  name="show_price"
                  checked
                />
                <label class="form-check-label" for="showPriceAdd">
                  {% trans "Show Price" %}
                </label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check p-3 border rounded">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="showQuantityAdd"
                  name="show_quantity"
                  checked
                />
                <label class="form-check-label" for="showQuantityAdd">
                  {% trans "Show Quantity" %}
                </label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check p-3 border rounded">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="placeOrdersAdd"
                  name="place_orders"
                  checked
                />
                <label class="form-check-label" for="placeOrdersAdd">
                  {% trans "Place Orders" %}
                </label>
              </div>
            </div>

            <!-- Multiple Images -->
            <div class="col-12">
              <div class="mb-3">
                <label for="productImagesAdd" class="form-label">
                  {% trans "Product Images" %}
                </label>
                <input
                  type="file"
                  class="form-control"
                  id="productImagesAdd"
                  name="images"
                  accept="image/*"
                  multiple
                />
                <div class="form-text">
                  {% trans "You can select multiple images. The first image will
                  be used as the main product image." %}
                </div>
              </div>
            </div>

            <!-- Video -->
            <div class="col-12">
              <div class="mb-3">
                <label for="productVideoAdd" class="form-label">
                  {% trans "Product Video" %}
                </label>
                <input
                  type="file"
                  class="form-control"
                  id="productVideoAdd"
                  name="video"
                  accept="video/*"
                />
                <div class="form-text">
                  {% trans "Optional - Upload a product video" %}
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          {% trans "Cancel" %}
        </button>
        <button type="button" class="btn btn-primary" id="createProductBtn">
          <i class="fas fa-plus me-2"></i>
          {% trans "Add Product" %}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Product Modal -->
<div
  class="modal fade"
  id="editProductModal"
  tabindex="-1"
  aria-labelledby="editProductModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content modern-modal">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title" id="editProductModalLabel">
          <i class="fas fa-edit me-2"></i>
          {% trans "Edit Product" %}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body p-3 p-md-4">
        <form id="productFormEdit" enctype="multipart/form-data">
          <input type="hidden" id="productIdEdit" />
          <div class="row g-3">
            <!-- Name -->
            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  id="productNameEdit"
                  name="name"
                  placeholder="{% trans 'Product Name' %}"
                  required
                />
                <label for="productNameEdit">{% trans "Product Name" %}</label>
              </div>
            </div>

            <!-- Price -->
            <div class="col-md-3">
              <div class="form-floating">
                <input
                  type="number"
                  class="form-control"
                  id="productPriceEdit"
                  name="price"
                  placeholder="{% trans 'Price' %}"
                  step="0.01"
                  required
                />
                <label for="productPriceEdit">{% trans "Price (د.ل)" %}</label>
              </div>
            </div>

            <!-- Discount Percentage -->
            <div class="col-md-3">
              <div class="form-floating">
                <input
                  type="number"
                  class="form-control"
                  id="productDiscountEdit"
                  name="discount_percentage"
                  placeholder="{% trans 'Discount %' %}"
                  step="0.01"
                  min="0"
                  max="100"
                />
                <label for="productDiscountEdit">
                  {% trans "Discount (%)" %}
                </label>
              </div>
            </div>

            <!-- Description -->
            <div class="col-12">
              <div class="form-floating">
                <textarea
                  class="form-control"
                  id="productDescriptionEdit"
                  name="description"
                  placeholder="{% trans 'Description' %}"
                  style="height: 100px"
                  required
                ></textarea>
                <label for="productDescriptionEdit">
                  {% trans "Description" %}
                </label>
              </div>
            </div>

            <!-- Quantity -->
            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="number"
                  class="form-control"
                  id="productQuantityEdit"
                  name="quantity_available"
                  placeholder="{% trans 'Quantity Available' %}"
                  required
                />
                <label for="productQuantityEdit">
                  {% trans "Quantity Available" %}
                </label>
              </div>
            </div>

            <!-- Category -->
            <div class="col-md-6">
              <div class="form-floating">
                <select
                  class="form-select"
                  id="productCategoryEdit"
                  name="category"
                  required
                >
                  <option value="">{% trans "Select Category" %}</option>
                  {% for category in categories %}
                  <option value="{{ category.id }}">{{ category.name }}</option>
                  {% endfor %}
                </select>
                <label for="productCategoryEdit">{% trans "Category" %}</label>
              </div>
            </div>

            <!-- Flags -->
            <div class="col-md-4">
              <div class="form-check p-3 border rounded">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="showPriceEdit"
                  name="show_price"
                />
                <label class="form-check-label" for="showPriceEdit">
                  {% trans "Show Price" %}
                </label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check p-3 border rounded">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="showQuantityEdit"
                  name="show_quantity"
                />
                <label class="form-check-label" for="showQuantityEdit">
                  {% trans "Show Quantity" %}
                </label>
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-check p-3 border rounded">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="placeOrdersEdit"
                  name="place_orders"
                />
                <label class="form-check-label" for="placeOrdersEdit">
                  {% trans "Place Orders" %}
                </label>
              </div>
            </div>

            <!-- Multiple Images (Edit) -->
            <!-- Multiple Images (Edit) -->
            <div class="col-12">
              <div class="mb-3">
                <label for="productImagesEdit" class="form-label">
                  {% trans "Product Images" %}
                </label>
                <input
                  type="file"
                  class="form-control"
                  id="productImagesEdit"
                  name="images"
                  accept="image/*"
                  multiple
                />
                <div class="form-text">
                  {% trans "Optional - Select images to replace the gallery. The
                  first one will be used as the main image." %}
                </div>

                <!-- Main image preview -->
                <img
                  id="productImagePreview"
                  src=""
                  alt=""
                  class="mt-2 img-fluid rounded"
                  style="max-height: 150px; display: none"
                />

                <!-- Gallery images preview (existing images) -->
                <div
                  id="productGalleryPreview"
                  class="mt-3 d-flex flex-wrap gap-2"
                  style="display: none"
                ></div>
                <div class="form-text">
                  {% trans "Existing gallery images" %}
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          {% trans "Cancel" %}
        </button>
        <button type="button" class="btn btn-warning" id="updateProductBtn">
          <i class="fas fa-save me-2"></i>
          {% trans "Update Product" %}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Branch Modal -->
<div
  class="modal fade"
  id="addBranchModal"
  tabindex="-1"
  aria-labelledby="addBranchModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modern-modal">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title" id="addBranchModalLabel">
          <i class="fas fa-map-marker-alt me-2"></i>
          {% trans "Add New Branch" %}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body p-3 p-md-4">
        <form id="branchFormAdd">
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-12">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  id="branchNameAdd"
                  name="name"
                  placeholder="{% trans 'Branch Name' %}"
                  required
                />
                <label for="branchNameAdd">{% trans "Branch Name" %}</label>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="tel"
                  class="form-control"
                  id="branchPhoneAdd"
                  name="phone_number"
                  placeholder="{% trans 'Phone Number' %}"
                />
                <label for="branchPhoneAdd">{% trans "Phone Number" %}</label>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="email"
                  class="form-control"
                  id="branchEmailAdd"
                  name="Email_Adress"
                  placeholder="{% trans 'Email Address' %}"
                />
                <label for="branchEmailAdd">{% trans "Email Address" %}</label>
              </div>
            </div>

            <div class="col-12">
              <div class="form-floating">
                <textarea
                  class="form-control"
                  id="branchAddressAdd"
                  name="address"
                  placeholder="{% trans 'Address' %}"
                  style="height: 80px"
                  required
                ></textarea>
                <label for="branchAddressAdd">{% trans "Address" %}</label>
              </div>
            </div>
            <div class="col-12 mb-3">
              <div
                id="branchMapAdd"
                style="height: 300px; width: 100%; border: 1px solid #ddd"
              ></div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="number"
                  step="any"
                  class="form-control"
                  id="branchLatitudeAdd"
                  name="latitude"
                  placeholder="{% trans 'Latitude' %}"
                  required
                />
                <label for="branchLatitudeAdd">{% trans "Latitude" %}</label>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="number"
                  step="any"
                  class="form-control"
                  id="branchLongitudeAdd"
                  name="longitude"
                  placeholder="{% trans 'Longitude' %}"
                  required
                />
                <label for="branchLongitudeAdd">{% trans "Longitude" %}</label>
              </div>
            </div>

            <!-- New Fields -->
            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  id="branchOpeningHoursAdd"
                  name="opening_hours"
                  placeholder="{% trans 'Opening Hours' %}"
                />
                <label for="branchOpeningHoursAdd"
                  >{% trans "Opening Hours" %}</label
                >
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  id="branchClosingHoursAdd"
                  name="closing_hours"
                  placeholder="{% trans 'Closing Hours' %}"
                />
                <label for="branchClosingHoursAdd"
                  >{% trans "Closing Hours" %}</label
                >
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  id="branchDayFromAdd"
                  name="day_from"
                  placeholder="{% trans 'Day From' %}"
                />
                <label for="branchDayFromAdd">{% trans "Day From" %}</label>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  id="branchDayToAdd"
                  name="day_to"
                  placeholder="{% trans 'Day To' %}"
                />
                <label for="branchDayToAdd">{% trans "Day To" %}</label>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="url"
                  class="form-control"
                  id="branchFacebookAdd"
                  name="facbook_link"
                  placeholder="{% trans 'Facebook Link' %}"
                />
                <label for="branchFacebookAdd"
                  >{% trans "Facebook Link" %}</label
                >
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="url"
                  class="form-control"
                  id="branchInstagramAdd"
                  name="instagram_link"
                  placeholder="{% trans 'Instagram Link' %}"
                />
                <label for="branchInstagramAdd"
                  >{% trans "Instagram Link" %}</label
                >
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="url"
                  class="form-control"
                  id="branchTwitterAdd"
                  name="twitter_link"
                  placeholder="{% trans 'Twitter Link' %}"
                />
                <label for="branchTwitterAdd">{% trans "Twitter Link" %}</label>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="url"
                  class="form-control"
                  id="branchLinkedinAdd"
                  name="linkdin_link"
                  placeholder="{% trans 'LinkedIn Link' %}"
                />
                <label for="branchLinkedinAdd"
                  >{% trans "LinkedIn Link" %}</label
                >
              </div>
            </div>

            <div class="col-12">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="primaryBranchAdd"
                  name="primery_branch"
                />
                <label class="form-check-label" for="primaryBranchAdd"
                  >{% trans "Primary Branch" %}</label
                >
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          {% trans "Cancel" %}
        </button>
        <button type="button" class="btn btn-success" id="createBranchBtn">
          <i class="fas fa-plus me-2"></i>
          {% trans "Add Branch" %}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Branch Modal -->
<!-- Edit Branch Modal -->
<div
  class="modal fade"
  id="editBranchModal"
  tabindex="-1"
  aria-labelledby="editBranchModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modern-modal">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="editBranchModalLabel">
          <i class="fas fa-edit me-2"></i>
          {% trans "Edit Branch" %}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body p-3 p-md-4">
        <form id="branchFormEdit">
          <input type="hidden" id="branchIdEdit" />
          <div class="row g-3">
            <!-- Basic Info -->
            <div class="col-12">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  id="branchNameEdit"
                  name="name"
                  placeholder="{% trans 'Branch Name' %}"
                  required
                />
                <label for="branchNameEdit">{% trans "Branch Name" %}</label>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="tel"
                  class="form-control"
                  id="branchPhoneEdit"
                  name="phone_number"
                  placeholder="{% trans 'Phone Number' %}"
                />
                <label for="branchPhoneEdit">{% trans "Phone Number" %}</label>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="email"
                  class="form-control"
                  id="branchEmailEdit"
                  name="Email_Adress"
                  placeholder="{% trans 'Email Address' %}"
                />
                <label for="branchEmailEdit">{% trans "Email Address" %}</label>
              </div>
            </div>

            <div class="col-12">
              <div class="form-floating">
                <textarea
                  class="form-control"
                  id="branchAddressEdit"
                  name="address"
                  placeholder="{% trans 'Address' %}"
                  style="height: 80px"
                  required
                ></textarea>
                <label for="branchAddressEdit">{% trans "Address" %}</label>
              </div>
            </div>
            <!-- For Edit modal -->
            <div class="col-12 mb-3">
              <div
                id="branchMapEdit"
                style="height: 300px; width: 100%; border: 1px solid #ddd"
              ></div>
            </div>
            <!-- Coordinates -->
            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="number"
                  step="any"
                  class="form-control"
                  id="branchLatitudeEdit"
                  name="latitude"
                  placeholder="{% trans 'Latitude' %}"
                  required
                />
                <label for="branchLatitudeEdit">{% trans "Latitude" %}</label>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="number"
                  step="any"
                  class="form-control"
                  id="branchLongitudeEdit"
                  name="longitude"
                  placeholder="{% trans 'Longitude' %}"
                  required
                />
                <label for="branchLongitudeEdit">{% trans "Longitude" %}</label>
              </div>
            </div>

            <!-- Hours & Days -->
            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  id="branchOpeningHoursEdit"
                  name="opening_hours"
                  placeholder="{% trans 'Opening Hours' %}"
                />
                <label for="branchOpeningHoursEdit"
                  >{% trans "Opening Hours" %}</label
                >
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  id="branchClosingHoursEdit"
                  name="closing_hours"
                  placeholder="{% trans 'Closing Hours' %}"
                />
                <label for="branchClosingHoursEdit"
                  >{% trans "Closing Hours" %}</label
                >
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  id="branchDayFromEdit"
                  name="day_from"
                  placeholder="{% trans 'Day From' %}"
                />
                <label for="branchDayFromEdit">{% trans "Day From" %}</label>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  id="branchDayToEdit"
                  name="day_to"
                  placeholder="{% trans 'Day To' %}"
                />
                <label for="branchDayToEdit">{% trans "Day To" %}</label>
              </div>
            </div>

            <!-- Social Links -->
            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="url"
                  class="form-control"
                  id="branchFacebookEdit"
                  name="facbook_link"
                  placeholder="{% trans 'Facebook Link' %}"
                />
                <label for="branchFacebookEdit"
                  >{% trans "Facebook Link" %}</label
                >
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="url"
                  class="form-control"
                  id="branchInstagramEdit"
                  name="instagram_link"
                  placeholder="{% trans 'Instagram Link' %}"
                />
                <label for="branchInstagramEdit"
                  >{% trans "Instagram Link" %}</label
                >
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="url"
                  class="form-control"
                  id="branchTwitterEdit"
                  name="twitter_link"
                  placeholder="{% trans 'Twitter Link' %}"
                />
                <label for="branchTwitterEdit"
                  >{% trans "Twitter Link" %}</label
                >
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="url"
                  class="form-control"
                  id="branchLinkedinEdit"
                  name="linkdin_link"
                  placeholder="{% trans 'LinkedIn Link' %}"
                />
                <label for="branchLinkedinEdit"
                  >{% trans "LinkedIn Link" %}</label
                >
              </div>
            </div>

            <!-- Primary Branch -->
            <div class="col-12">
              <div class="form-check">
                <input
                  class="form-check-input"
                  type="checkbox"
                  id="primaryBranchEdit"
                  name="primery_branch"
                />
                <label class="form-check-label" for="primaryBranchEdit"
                  >{% trans "Primary Branch" %}</label
                >
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          {% trans "Cancel" %}
        </button>
        <button type="button" class="btn btn-info" id="updateBranchBtn">
          <i class="fas fa-save me-2"></i>
          {% trans "Update Branch" %}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Category Modal -->
<div
  class="modal fade"
  id="addCategoryModal"
  tabindex="-1"
  aria-labelledby="addCategoryModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modern-modal">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title" id="addCategoryModalLabel">
          <i class="fas fa-plus me-2"></i>
          {% trans "Add Category" %}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body p-3 p-md-4">
        <form id="categoryFormAdd" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-12">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  id="categoryNameAdd"
                  name="name"
                  placeholder="{% trans 'Category Name' %}"
                  required
                />
                <label for="categoryNameAdd">{% trans "Category Name" %}</label>
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea
                  class="form-control"
                  id="categoryDescriptionAdd"
                  name="description"
                  placeholder="{% trans 'Description' %}"
                  style="height: 80px"
                ></textarea>
                <label for="categoryDescriptionAdd"
                  >{% trans "Description" %}</label
                >
              </div>
            </div>
            <div class="col-12">
              <div class="mb-3">
                <label for="categoryImageAdd" class="form-label"
                  >{% trans "Category Image" %}</label
                >
                <input
                  type="file"
                  class="form-control"
                  id="categoryImageAdd"
                  name="image"
                  accept="image/*"
                />
                <div class="form-text">
                  {% trans "Optional - Upload a category image" %}
                </div>
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          {% trans "Cancel" %}
        </button>
        <button type="button" class="btn btn-warning" id="createCategoryBtn">
          <i class="fas fa-plus me-2"></i>
          {% trans "Add Category" %}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Category Modal -->
<div
  class="modal fade"
  id="editCategoryModal"
  tabindex="-1"
  aria-labelledby="editCategoryModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modern-modal">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title" id="editCategoryModalLabel">
          <i class="fas fa-edit me-2"></i>
          {% trans "Edit Category" %}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body p-3 p-md-4">
        <form id="categoryFormEdit" enctype="multipart/form-data">
          <input type="hidden" id="categoryIdEdit" />
          <div class="row g-3">
            <div class="col-12">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  id="categoryNameEdit"
                  name="name"
                  placeholder="{% trans 'Category Name' %}"
                  required
                />
                <label for="categoryNameEdit"
                  >{% trans "Category Name" %}</label
                >
              </div>
            </div>
            <div class="col-12">
              <div class="form-floating">
                <textarea
                  class="form-control"
                  id="categoryDescriptionEdit"
                  name="description"
                  placeholder="{% trans 'Description' %}"
                  style="height: 80px"
                ></textarea>
                <label for="categoryDescriptionEdit"
                  >{% trans "Description" %}</label
                >
              </div>
            </div>
            <div class="col-12">
              <div class="mb-3">
                <label for="categoryImageEdit" class="form-label"
                  >{% trans "Category Image" %}</label
                >
                <input
                  type="file"
                  class="form-control"
                  id="categoryImageEdit"
                  name="image"
                  accept="image/*"
                />
                <div class="form-text">
                  {% trans "Optional - Leave empty to keep current image" %}
                </div>
                <img
                  id="categoryImagePreview"
                  src=""
                  alt=""
                  class="mt-2 img-fluid rounded"
                  style="max-height: 150px; display: none"
                />
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          {% trans "Cancel" %}
        </button>
        <button type="button" class="btn btn-warning" id="updateCategoryBtn">
          <i class="fas fa-save me-2"></i>
          {% trans "Update Category" %}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add City Modal -->
<div
  class="modal fade"
  id="addCityModal"
  tabindex="-1"
  aria-labelledby="addCityModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modern-modal">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title" id="addCityModalLabel">
          <i class="fas fa-city me-2"></i>
          {% trans "Add New City" %}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body p-3 p-md-4">
        <form id="cityFormAdd">
          {% csrf_token %}
          <div class="form-floating mb-3">
            <input
              type="text"
              class="form-control"
              id="cityNameAdd"
              name="name"
              placeholder="{% trans 'City Name' %}"
              required
            />
            <label for="cityNameAdd">{% trans "City Name" %}</label>
          </div>

          <div class="form-floating mb-3">
            <input
              type="number"
              step="0.01"
              class="form-control"
              id="cityDeliveryFeeAdd"
              name="delivery_fee"
              placeholder="{% trans 'Delivery Fee' %}"
              value="0.00"
              required
            />
            <label for="cityDeliveryFeeAdd"
              >{% trans "Delivery Fee (د.ل)" %}</label
            >
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          {% trans "Cancel" %}
        </button>
        <button type="button" class="btn btn-secondary" id="createCityBtn">
          <i class="fas fa-plus me-2"></i>
          {% trans "Add City" %}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit City Modal -->
<div
  class="modal fade"
  id="editCityModal"
  tabindex="-1"
  aria-labelledby="editCityModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modern-modal">
      <div class="modal-header bg-secondary text-white">
        <h5 class="modal-title" id="editCityModalLabel">
          <i class="fas fa-edit me-2"></i>
          {% trans "Edit City" %}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body p-3 p-md-4">
        <form id="cityFormEdit">
          <input type="hidden" id="cityIdEdit" />
          <div class="form-floating mb-3">
            <input
              type="text"
              class="form-control"
              id="cityNameEdit"
              name="name"
              placeholder="{% trans 'City Name' %}"
              required
            />
            <label for="cityNameEdit">{% trans "City Name" %}</label>
          </div>

          <div class="form-floating mb-3">
            <input
              type="number"
              step="0.01"
              class="form-control"
              id="cityDeliveryFeeEdit"
              name="delivery_fee"
              placeholder="{% trans 'Delivery Fee' %}"
              required
            />
            <label for="cityDeliveryFeeEdit"
              >{% trans "Delivery Fee (د.ل)" %}</label
            >
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          {% trans "Cancel" %}
        </button>
        <button type="button" class="btn btn-secondary" id="updateCityBtn">
          <i class="fas fa-save me-2"></i>
          {% trans "Update City" %}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View Message Modal -->
<div
  class="modal fade"
  id="viewMessageModal"
  tabindex="-1"
  aria-labelledby="viewMessageModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modern-modal">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="viewMessageModalLabel">
          <i class="fas fa-envelope me-2"></i>
          {% trans "Message Details" %}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body p-3 p-md-4">
        <div class="mb-3">
          <label class="form-label fw-bold">{% trans "From:" %}</label>
          <p id="messageEmail" class="text-muted"></p>
        </div>
        <div class="mb-3">
          <label class="form-label fw-bold">{% trans "Message:" %}</label>
          <div
            id="messageContent"
            class="border rounded p-3 bg-light"
            style="min-height: 150px"
          ></div>
        </div>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          {% trans "Close" %}
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal fade" id="addBannerModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content modern-modal">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="fas fa-plus-circle me-2"></i> Add Banner
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>

      <div class="modal-body p-3">
        <form id="bannerFormAdd" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  name="title"
                  id="bannerTitleAdd"
                  required
                />
                <label>Title</label>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="number"
                  class="form-control"
                  name="order"
                  id="bannerOrderAdd"
                  value="0"
                />
                <label>Order</label>
              </div>
            </div>

            <div class="col-12">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  name="subtitle"
                  id="bannerSubtitleAdd"
                />
                <label>Subtitle</label>
              </div>
            </div>

            <div class="col-6">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  name="button_text"
                  id="bannerButtonTextAdd"
                />
                <label>Button Text</label>
              </div>
            </div>

            <div class="col-6">
              <div class="form-floating">
                <input
                  type="url"
                  class="form-control"
                  name="button_link"
                  id="bannerButtonLinkAdd"
                />
                <label>Button Link</label>
              </div>
            </div>

            <div class="col-6">
              <div class="form-floating">
                <select
                  class="form-select"
                  name="text_color"
                  id="bannerColorAdd"
                >
                  <option value="white">White</option>
                  <option value="black">Black</option>
                </select>
                <label>Text Color</label>
              </div>
            </div>

            <div class="col-6">
              <div class="form-check p-3 border rounded">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="is_active"
                  id="bannerActiveAdd"
                  checked
                />
                <label class="form-check-label">Active</label>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Banner Image</label>
              <input
                type="file"
                class="form-control"
                name="image"
                accept="image/*"
                required
              />
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button class="btn btn-primary" id="createBannerBtn">Add Banner</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Banner Modal -->
<div class="modal fade" id="editBannerModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content modern-modal">
      <div class="modal-header bg-warning text-white">
        <h5 class="modal-title">
          <i class="fas fa-edit me-2"></i> Edit Banner
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>

      <div class="modal-body p-3 p-md-4">
        <form id="bannerFormEdit" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="hidden" id="bannerIdEdit" />

          <div class="row g-3">
            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  name="title"
                  id="bannerTitleEdit"
                  required
                />
                <label>Title</label>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-floating">
                <input
                  type="number"
                  class="form-control"
                  name="order"
                  id="bannerOrderEdit"
                />
                <label>Order</label>
              </div>
            </div>

            <div class="col-12">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  name="subtitle"
                  id="bannerSubtitleEdit"
                />
                <label>Subtitle</label>
              </div>
            </div>

            <div class="col-6">
              <div class="form-floating">
                <input
                  type="text"
                  class="form-control"
                  name="button_text"
                  id="bannerButtonTextEdit"
                />
                <label>Button Text</label>
              </div>
            </div>

            <div class="col-6">
              <div class="form-floating">
                <input
                  type="url"
                  class="form-control"
                  name="button_link"
                  id="bannerButtonLinkEdit"
                />
                <label>Button Link</label>
              </div>
            </div>

            <div class="col-6">
              <div class="form-floating">
                <select
                  class="form-select"
                  name="text_color"
                  id="bannerColorEdit"
                >
                  <option value="white">White</option>
                  <option value="black">Black</option>
                </select>
                <label>Text Color</label>
              </div>
            </div>

            <div class="col-6">
              <div class="form-check p-3 border rounded">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="is_active"
                  id="bannerActiveEdit"
                />
                <label class="form-check-label">Active</label>
              </div>
            </div>

            <div class="col-12">
              <label class="form-label">Banner Image (optional)</label>
              <input
                type="file"
                class="form-control"
                name="image"
                id="bannerImageEdit"
                accept="image/*"
              />
              <div class="form-text">Leave empty to keep existing image</div>

              <img
                id="bannerImagePreview"
                src=""
                class="img-fluid rounded mt-2"
                style="max-height: 150px; display: none"
              />
            </div>
          </div>
        </form>
      </div>

      <div class="modal-footer">
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button class="btn btn-warning" id="updateBannerBtn">
          Update Banner
        </button>
      </div>
    </div>
  </div>
</div>
<div id="printableArea" style="display: none">
  {% load static %} {% for invoice in invoices %}
  <div
    id="invoice-{{ invoice.id }}"
    style="
      padding: 20px;
      font-family: Arial, sans-serif;
      direction: rtl;
      text-align: right;
      background: #fff;
      color: #333;
    "
  >
    <!-- Header -->
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      "
    >
      <img
        src="{{ request.scheme }}://{{ request.get_host }}{% static 'main/img/awferlek-logo-no-bg.png' %}"
        alt="Logo"
        style="height: 60px"
      />
      <div style="text-align: right">
        <h2 style="margin: 0">فاتورة</h2>
        <p style="margin: 0">#{{ invoice.id }}</p>
      </div>
    </div>

    <!-- Customer Info -->
    <div style="margin-bottom: 20px; line-height: 1.5">
      <p><strong>الاسم:</strong> {{ invoice.name|default:"ضيف" }}</p>
      <p><strong>المدينة:</strong> {{ invoice.city }}</p>
      <p><strong>العنوان:</strong> {{ invoice.address }}</p>
      <p><strong>الهاتف:</strong> {{ invoice.phone }}</p>
    </div>

    <!-- Items Table -->
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px">
      <thead>
        <tr style="background: #f5f5f5; text-align: center">
          <th style="border: 1px solid #ccc; padding: 8px">المنتج</th>
          <th style="border: 1px solid #ccc; padding: 8px">رقم المنتج</th>
          <th style="border: 1px solid #ccc; padding: 8px">الكمية</th>
          <th style="border: 1px solid #ccc; padding: 8px">السعر الأصلي</th>
          <th style="border: 1px solid #ccc; padding: 8px">نسبة الخصم %</th>
          <th style="border: 1px solid #ccc; padding: 8px">السعر بعد الخصم</th>
          <th style="border: 1px solid #ccc; padding: 8px">المجموع</th>
        </tr>
      </thead>
      <tbody>
        {% for item in invoice.items.all %}
        <tr style="text-align: center">
          <td style="border: 1px solid #ccc; padding: 6px">
            {{ item.name|default:"-" }}
          </td>
          <td style="border: 1px solid #ccc; padding: 6px">
            {{ item.product_id }}
          </td>
          <td style="border: 1px solid #ccc; padding: 6px">
            {{ item.quantity }}
          </td>
          <td style="border: 1px solid #ccc; padding: 6px">
            د.ل{{ item.original_price }}
          </td>
          <!-- prettier-ignore -->
          <td style="border: 1px solid #ccc; padding: 6px">
            {% if item.discount_percentage %}
            {{ item.discount_percentage }}%
            {% else %}0%{% endif %}
          </td>
          <td style="border: 1px solid #ccc; padding: 6px">
            د.ل{{ item.price }}
          </td>
          <td style="border: 1px solid #ccc; padding: 6px">
            د.ل{{ item.subtotal }}
          </td>
        </tr>
        {% endfor %}
        <!-- prettier-ignore -->
        {% if invoice.delivery_fee and invoice.delivery_fee|floatformat:2 != '0.00' %}
        <tr style="text-align: center; background: #fffbdd">
          <td style="border: 1px solid #ccc; padding: 6px">رسوم التوصيل</td>
          <td style="border: 1px solid #ccc; padding: 6px">—</td>
          <td style="border: 1px solid #ccc; padding: 6px">1</td>
          <td style="border: 1px solid #ccc; padding: 6px">
            د.ل{{ invoice.delivery_fee }}
          </td>
          <td style="border: 1px solid #ccc; padding: 6px">0%</td>
          <td style="border: 1px solid #ccc; padding: 6px">
            د.ل{{ invoice.delivery_fee }}
          </td>
          <td style="border: 1px solid #ccc; padding: 6px">
            د.ل{{ invoice.delivery_fee }}
          </td>
        </tr>
        {% endif %}
      </tbody>
    </table>

    <!-- Total -->
    <div
      style="
        text-align: right;
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 20px;
      "
    >
      المجموع الكلي: د.ل{{ invoice.total }}
    </div>

    <hr style="border: 1px dashed #ccc; margin: 20px 0" />
  </div>
  {% endfor %}
</div>

<!-- Confirmation Modal -->
<div
  class="modal fade"
  id="confirmModal"
  tabindex="-1"
  aria-labelledby="confirmModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content modern-modal">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i>
          {% trans "Confirm Action" %}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body p-3 p-md-4">
        <p id="confirmMessage">
          {% trans "Are you sure you want to perform this action?" %}
        </p>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          {% trans "Cancel" %}
        </button>
        <button type="button" class="btn btn-danger" id="confirmActionBtn">
          <i class="fas fa-check me-2"></i>
          {% trans "Confirm" %}
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Add Brand Modal -->
<div
  class="modal fade"
  id="addBrandModal"
  tabindex="-1"
  aria-labelledby="addBrandModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content modern-modal">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="addBrandModalLabel">
          <i class="fas fa-industry me-2"></i>
          {% trans "Add Brand" %}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form
          id="brandFormAdd"
          class="needs-validation"
          novalidate
          enctype="multipart/form-data"
        >
          {% csrf_token %}
          <div class="mb-3">
            <label for="brandNameAdd" class="form-label"
              >{% trans "Name" %}</label
            >
            <input
              type="text"
              class="form-control"
              id="brandNameAdd"
              name="name"
              required
            />
            <div class="invalid-feedback">
              {% trans "Please enter a brand name." %}
            </div>
          </div>

          <div class="mb-3">
            <label for="brandDescriptionAdd" class="form-label"
              >{% trans "Description" %}</label
            >
            <textarea
              class="form-control"
              id="brandDescriptionAdd"
              name="description"
              rows="3"
            ></textarea>
          </div>

          <div class="mb-3">
            <label for="brandImageAdd" class="form-label"
              >{% trans "Image" %}</label
            >
            <input
              type="file"
              class="form-control"
              id="brandImageAdd"
              name="image"
              accept="image/*"
            />
            <div class="form-text">
              {% trans "Optional - Upload a brand image" %}
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          {% trans "Cancel" %}
        </button>
        <button type="button" class="btn btn-info" id="createBrandBtn">
          <i class="fas fa-plus me-2"></i>
          {% trans "Add Brand" %}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Brand Modal -->
<div
  class="modal fade"
  id="editBrandModal"
  tabindex="-1"
  aria-labelledby="editBrandModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content modern-modal">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" id="editBrandModalLabel">
          <i class="fas fa-edit me-2"></i>
          {% trans "Edit Brand" %}
        </h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <form
          id="brandFormEdit"
          class="needs-validation"
          novalidate
          enctype="multipart/form-data"
        >
          <input type="hidden" id="brandIdEdit" name="brand_id" />
          <div class="mb-3">
            <label for="brandNameEdit" class="form-label"
              >{% trans "Name" %}</label
            >
            <input
              type="text"
              class="form-control"
              id="brandNameEdit"
              name="name"
              required
            />
            <div class="invalid-feedback">
              {% trans "Please enter a brand name." %}
            </div>
          </div>

          <div class="mb-3">
            <label for="brandDescriptionEdit" class="form-label"
              >{% trans "Description" %}</label
            >
            <textarea
              class="form-control"
              id="brandDescriptionEdit"
              name="description"
              rows="3"
            ></textarea>
          </div>

          <div class="mb-3">
            <label for="brandImageEdit" class="form-label"
              >{% trans "Image" %}</label
            >
            <input
              type="file"
              class="form-control"
              id="brandImageEdit"
              name="image"
              accept="image/*"
            />
            <div class="form-text">
              {% trans "Optional - Leave empty to keep current image" %}
            </div>
          </div>

          <div class="mb-3">
            <img
              id="brandImagePreview"
              src=""
              alt="Brand Image Preview"
              class="img-fluid rounded"
              style="display: none; max-height: 150px"
            />
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          {% trans "Cancel" %}
        </button>
        <button type="button" class="btn btn-info" id="updateBrandBtn">
          <i class="fas fa-save me-2"></i>
          {% trans "Update Brand" %}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- prettier-ignore-start -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // ✅ Modal Guardian (fix gray screen / stuck backdrop)
    const __cleanupModalArtifacts = () => {
      // remove leftover backdrops and restore body if no modal is open
      if (!document.querySelector(".modal.show")) {
        document.body.classList.remove("modal-open");
        document.body.style.removeProperty("padding-right");
        document.body.style.removeProperty("overflow");
        document.querySelectorAll(".modal-backdrop").forEach((b) => b.remove());
      }
    };

    document.addEventListener("hidden.bs.modal", () =>
      setTimeout(__cleanupModalArtifacts, 20)
    );
    window.addEventListener("error", () =>
      setTimeout(__cleanupModalArtifacts, 20)
    );

    // Prevent stacked modals (optional safety)
    document.addEventListener("show.bs.modal", (e) => {
      document.querySelectorAll(".modal.show").forEach((m) => {
        if (m !== e.target) bootstrap.Modal.getInstance(m)?.hide();
      });
    });

    const App = {
      // ====== CONFIG ======
      urls: {
        // Products
        createProduct: "{% url 'create_product' %}",
        productDetail: (id) => `/products/api/${id}/`,
        productUpdate: (id) => `/products/api/${id}/`,
        productDelete: (id) => `/products/api/${id}/delete/`,

        // Branches
        createBranch: "{% url 'create_branch' %}",
        branchDetail: (id) => `/branches/api/${id}/`,
        branchUpdate: (id) => `/branches/api/${id}/`,
        branchDelete: (id) =>
          "{% url 'branch_delete_api' 0 %}".replace("0", id),

        // Categories
        createCategory: "{% url 'category_add' %}",
        categoryUpdate: (id) =>
          "{% url 'category_update' 0 %}".replace("0", id),
        categoryDelete: (id) => `/api/category/${id}/delete/`,

        // Cities
        createCity: "{% url 'create_city' %}",
        cityDetail: (id) => `/cities/api/${id}/`,
        cityUpdate: (id) => "{% url 'city_detail_api' 0 %}".replace("0", id),
        cityDelete: (id) => "{% url 'city_delete_api' 0 %}".replace("0", id),

        // Brands
        createBrand: "{% url 'brand_add' %}",
        brandUpdate: (id) => "{% url 'brand_update' 0 %}".replace("0", id),
        brandDelete: (id) => "{% url 'brand_delete' 0 %}".replace("0", id),

        // Banners
        bannerAdd: "{% url 'banner_add' %}",
        bannerDetail: (id) => `/banners/api/${id}/`,
        bannerUpdate: (id) => `/banners/api/${id}/`,
        bannerDelete: (id) =>
          "{% url 'banner_delete_api' 0 %}".replace("0", id),

        // Projects (DRF ViewSet)
        projectsBase: "/api/projects/",
        projectDetail: (id) => `/api/projects/${id}/`,
      },

      csrfToken:
        document.querySelector("[name=csrfmiddlewaretoken]")?.value ||
        (function getCookie(name) {
          const v = `; ${document.cookie}`;
          const p = v.split(`; ${name}=`);
          if (p.length === 2) return p.pop().split(";").shift();
          return "";
        })("csrftoken"),

      // ====== STATE ======
      confirmCtx: null, // { type, id, buttonEl, onConfirm() }
      branchMaps: {
        addMap: null,
        addMarker: null,
        editMap: null,
        editMarker: null,
      },

      // ====== INIT ======
      init() {
        this.bindGlobalEvents();
        this.bindButtons();
        this.initTooltips();
        this.initFormValidation();
        this.adjustTablesForMobile();
        window.addEventListener("resize", () => this.adjustTablesForMobile());

        // Projects initial load (if section exists)
        if (document.getElementById("projectsGrid")) {
          this.projects.fetch();
        }

        console.log("Dashboard App initialized ✅");
      },

      // ====== UTILITIES ======
      async request(
        url,
        { method = "GET", body = null, isFormData = false } = {}
      ) {
        const headers = { "X-CSRFToken": this.csrfToken };

        if (!isFormData && body && !(body instanceof FormData)) {
          headers["Content-Type"] = "application/json";
        }

        const res = await fetch(url, {
          method,
          headers,
          credentials: "same-origin",
          body: body
            ? isFormData || body instanceof FormData
              ? body
              : JSON.stringify(body)
            : null,
        });

        const data = await res.json().catch(() => ({}));
        if (!res.ok) {
          throw new Error(
            data.error || data.detail || data.message || `HTTP ${res.status}`
          );
        }
        return data;
      },

      showAlert(message, type = "success") {
        document.querySelector(".dashboard-alert")?.remove();

        const alertDiv = document.createElement("div");
        const bsType = type === "error" ? "danger" : type;

        alertDiv.className = `alert alert-${bsType} alert-dismissible fade show dashboard-alert`;
        alertDiv.style.cssText =
          "position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; min-width: 300px; max-width: 520px;";

        alertDiv.innerHTML = `
          <div class="d-flex align-items-center">
            <i class="fas fa-${
              bsType === "success" ? "check-circle" : "exclamation-triangle"
            } me-2"></i>
            <div>${message}</div>
          </div>
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        document.body.appendChild(alertDiv);
        setTimeout(() => alertDiv.remove(), 4500);
      },

      setLoading(button, isLoading, loadingText = "Processing...") {
        if (!button) return;
        if (isLoading) {
          button.disabled = true;
          button.dataset.originalHtml ||= button.innerHTML;
          button.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>${loadingText}`;
        } else {
          button.disabled = false;
          button.innerHTML = button.dataset.originalHtml || button.innerHTML;
        }
      },

      serializeForm(formId, { skipFiles = true } = {}) {
        const form = document.getElementById(formId);
        if (!form) return {};
        const fd = new FormData(form);
        const data = {};

        fd.forEach((value, key) => {
          if (skipFiles && value instanceof File) return;

          const el = form.elements[key];
          if (el?.type === "checkbox") data[key] = el.checked;
          else data[key] = value;
        });

        return data;
      },

      openModal(modalId) {
        const el = document.getElementById(modalId);
        if (!el) return null;
        const modal = new bootstrap.Modal(el);
        modal.show();
        return modal;
      },

      closeModal(modalId) {
        const el = document.getElementById(modalId);
        if (!el) return;
        const modal = bootstrap.Modal.getInstance(el);
        modal?.hide();
      },

      escapeHtml(s) {
        return (s || "").replace(
          /[&<>"']/g,
          (m) =>
            ({
              "&": "&amp;",
              "<": "&lt;",
              ">": "&gt;",
              '"': "&quot;",
              "'": "&#039;",
            }[m])
        );
      },

      // ====== GLOBAL EVENTS ======
      bindGlobalEvents() {
        // Delegation for edit/delete buttons and other actions
        document.addEventListener("click", (e) => {
          // Products
          const editProduct = e.target.closest(".edit-product-btn");
          if (editProduct)
            return this.products.load(editProduct.dataset.productId);

          const delProduct = e.target.closest(".delete-product-btn");
          if (delProduct) {
            return this.confirmDelete({
              type: "product",
              id: delProduct.dataset.productId,
              buttonEl: delProduct,
              message: "Are you sure you want to delete this product?",
              onConfirm: () =>
                this.products.delete(delProduct.dataset.productId, delProduct),
            });
          }

          // Branches
          const editBranch = e.target.closest(".edit-branch-btn");
          if (editBranch)
            return this.branches.load(editBranch.dataset.branchId);

          const delBranch = e.target.closest(".delete-branch-btn");
          if (delBranch) {
            return this.confirmDelete({
              type: "branch",
              id: delBranch.dataset.branchId,
              buttonEl: delBranch,
              message: "Are you sure you want to delete this branch?",
              onConfirm: () =>
                this.branches.delete(delBranch.dataset.branchId, delBranch),
            });
          }

          // Categories
          const editCategory = e.target.closest(".edit-category-btn");
          if (editCategory)
            return this.categories.loadFromDataset(editCategory);

          const delCategory = e.target.closest(".delete-category-btn");
          if (delCategory) {
            return this.confirmDelete({
              type: "category",
              id: delCategory.dataset.categoryId,
              buttonEl: delCategory,
              message: "Are you sure you want to delete this category?",
              onConfirm: () =>
                this.categories.delete(
                  delCategory.dataset.categoryId,
                  delCategory
                ),
            });
          }

          // Cities
          const editCity = e.target.closest(".edit-city-btn");
          if (editCity) return this.cities.load(editCity.dataset.cityId);

          const delCity = e.target.closest(".delete-city-btn");
          if (delCity) {
            return this.confirmDelete({
              type: "city",
              id: delCity.dataset.cityId,
              buttonEl: delCity,
              message: "Are you sure you want to delete this city?",
              onConfirm: () =>
                this.cities.delete(delCity.dataset.cityId, delCity),
            });
          }

          // Brands
          const editBrand = e.target.closest(".edit-brand-btn");
          if (editBrand) return this.brands.loadFromDataset(editBrand);

          const delBrand = e.target.closest(".delete-brand-btn");
          if (delBrand) {
            return this.confirmDelete({
              type: "brand",
              id: delBrand.dataset.brandId,
              buttonEl: delBrand,
              message: "Are you sure you want to delete this brand?",
              onConfirm: () =>
                this.brands.delete(delBrand.dataset.brandId, delBrand),
            });
          }

          // Banners
          const editBanner = e.target.closest(".edit-banner-btn");
          if (editBanner) return this.banners.load(editBanner.dataset.bannerId);

          const delBanner = e.target.closest(".delete-banner-btn");
          if (delBanner) {
            return this.confirmDelete({
              type: "banner",
              id: delBanner.dataset.bannerId,
              buttonEl: delBanner,
              message: "Delete this banner?",
              onConfirm: () =>
                this.banners.delete(delBanner.dataset.bannerId, delBanner),
            });
          }

          // View message
          const viewMsg = e.target.closest(
            '[data-bs-target="#viewMessageModal"]'
          );
          if (viewMsg) {
            return this.messages.view(
              viewMsg.dataset.message,
              viewMsg.dataset.email
            );
          }

          // Projects actions
          const projBtn = e.target.closest("button[data-project-action]");
          if (projBtn) {
            const id = projBtn.dataset.projectId;
            const action = projBtn.dataset.projectAction;
            if (action === "edit") return this.projects.openEdit(id);
            if (action === "delete") {
              return this.confirmDelete({
                type: "project",
                id,
                buttonEl: projBtn,
                message: "Delete this project?",
                onConfirm: () => this.projects.delete(id),
              });
            }
          }
        });

        // confirm modal reset
        const confirmModal = document.getElementById("confirmModal");
        confirmModal?.addEventListener("hidden.bs.modal", () => {
          this.confirmCtx = null;
          const btn = document.getElementById("confirmActionBtn");
          if (btn) btn.onclick = null;
        });
      },

      bindButtons() {
        // Products
        document
          .getElementById("createProductBtn")
          ?.addEventListener("click", () => this.products.create());
        document
          .getElementById("updateProductBtn")
          ?.addEventListener("click", () => this.products.update());

        // Branches
        document
          .getElementById("createBranchBtn")
          ?.addEventListener("click", () => this.branches.create());
        document
          .getElementById("updateBranchBtn")
          ?.addEventListener("click", () => this.branches.update());

        // Categories
        document
          .getElementById("createCategoryBtn")
          ?.addEventListener("click", () => this.categories.create());
        document
          .getElementById("updateCategoryBtn")
          ?.addEventListener("click", () => this.categories.update());

        // Cities
        document
          .getElementById("createCityBtn")
          ?.addEventListener("click", () => this.cities.create());
        document
          .getElementById("updateCityBtn")
          ?.addEventListener("click", () => this.cities.update());

        // Brands
        document
          .getElementById("createBrandBtn")
          ?.addEventListener("click", () => this.brands.create());
        document
          .getElementById("updateBrandBtn")
          ?.addEventListener("click", () => this.brands.update());

        // Banners
        document
          .getElementById("createBannerBtn")
          ?.addEventListener("click", () => this.banners.create());
        document
          .getElementById("updateBannerBtn")
          ?.addEventListener("click", () => this.banners.update());

        // Projects
        document
          .getElementById("btnOpenCreateProject")
          ?.addEventListener("click", () => this.projects.openCreate());
        document
          .getElementById("projectForm")
          ?.addEventListener("submit", (e) => {
            e.preventDefault();
            this.projects.submit(e);
          });
        document
          .getElementById("confirmDeleteProjectBtn")
          ?.addEventListener("click", () => {
            // optional if you use separate deleteProjectModal
            const id = document.getElementById("deleteProjectId")?.value;
            if (id) this.projects.delete(id);
          });
      },

      initTooltips() {
        const list = [].slice.call(document.querySelectorAll("[title]"));
        list.map((el) => new bootstrap.Tooltip(el, { trigger: "hover" }));
      },

      initFormValidation() {
        const forms = document.querySelectorAll(".needs-validation");
        Array.from(forms).forEach((form) => {
          form.addEventListener(
            "submit",
            (event) => {
              if (!form.checkValidity()) {
                event.preventDefault();
                event.stopPropagation();
              }
              form.classList.add("was-validated");
            },
            false
          );
        });
      },

      adjustTablesForMobile() {
        document.querySelectorAll(".table-responsive").forEach((t) => {
          if (window.innerWidth < 768) t.classList.add("table-sm");
          else t.classList.remove("table-sm");
        });
      },

      // ====== CONFIRM ======
      confirmDelete({ type, id, buttonEl, message, onConfirm }) {
        this.confirmCtx = { type, id, buttonEl, onConfirm };

        const msgEl = document.getElementById("confirmMessage");
        if (msgEl) msgEl.textContent = message || "Are you sure?";

        const modal = this.openModal("confirmModal");
        const confirmBtn = document.getElementById("confirmActionBtn");
        if (confirmBtn) confirmBtn.onclick = () => this.performConfirm();

        return modal;
      },

      async performConfirm() {
        if (!this.confirmCtx) return;

        try {
          await this.confirmCtx.onConfirm?.();
          this.closeModal("confirmModal");
        } catch (e) {
          this.showAlert(`Error: ${e.message}`, "error");
        }
      },

      // ====== MODULES ======
      products: {
        async create() {
          const btn = document.getElementById("createProductBtn");
          const form = document.getElementById("productFormAdd");
          if (!form || !form.checkValidity()) {
            form?.classList.add("was-validated");
            return;
          }

          App.setLoading(btn, true);

          try {
            const fd = new FormData(form);

            ["show_price", "show_quantity", "place_orders"].forEach((field) => {
              const cb = form.querySelector(`[name="${field}"]`);
              if (cb) fd.set(field, cb.checked ? "true" : "false");
            });

            await App.request(App.urls.createProduct, {
              method: "POST",
              body: fd,
              isFormData: true,
            });
            App.showAlert("Product created successfully!", "success");
            setTimeout(() => location.reload(), 800);
          } catch (e) {
            App.showAlert(`Error: ${e.message}`, "error");
          } finally {
            App.setLoading(btn, false);
          }
        },

        async load(id) {
          try {
            const data = await App.request(App.urls.productDetail(id));

            document.getElementById("productIdEdit").value = data.id;
            document.getElementById("productNameEdit").value = data.name || "";
            document.getElementById("productDescriptionEdit").value =
              data.description || "";
            document.getElementById("productQuantityEdit").value =
              data.quantity_available || "";
            document.getElementById("productPriceEdit").value =
              data.price || "";
            document.getElementById("productCategoryEdit").value =
              data.category?.id || "";

            document.getElementById("showPriceEdit").checked =
              !!data.show_price;
            document.getElementById("showQuantityEdit").checked =
              !!data.show_quantity;
            document.getElementById("placeOrdersEdit").checked =
              !!data.place_orders;

            const preview = document.getElementById("productImagePreview");
            if (data.image_url) {
              preview.src = data.image_url;
              preview.style.display = "block";
            } else {
              preview.style.display = "none";
            }

            App.openModal("editProductModal");
          } catch (e) {
            App.showAlert("Failed to load product data", "error");
          }
        },

        async update() {
          const btn = document.getElementById("updateProductBtn");
          const form = document.getElementById("productFormEdit");
          const id = document.getElementById("productIdEdit")?.value;

          if (!form || !id || !form.checkValidity()) {
            form?.classList.add("was-validated");
            return;
          }

          App.setLoading(btn, true);

          try {
            const fd = new FormData(form);
            ["show_price", "show_quantity", "place_orders"].forEach((field) => {
              const cb = form.querySelector(`[name="${field}"]`);
              if (cb) fd.set(field, cb.checked ? "true" : "false");
            });

            await App.request(App.urls.productUpdate(id), {
              method: "POST",
              body: fd,
              isFormData: true,
            });
            App.showAlert("Product updated successfully!", "success");
            setTimeout(() => location.reload(), 800);
          } catch (e) {
            App.showAlert(`Error: ${e.message}`, "error");
          } finally {
            App.setLoading(btn, false);
          }
        },

        async delete(id, btnEl) {
          const data = await App.request(App.urls.productDelete(id), {
            method: "POST",
          });
          if (data.success) {
            btnEl?.closest("tr")?.remove();
            App.showAlert("Product deleted successfully!", "success");
          }
        },
      },

      branches: {
        async create() {
          const btn = document.getElementById("createBranchBtn");
          const form = document.getElementById("branchFormAdd");
          if (!form || !form.checkValidity()) {
            form?.classList.add("was-validated");
            return;
          }

          App.setLoading(btn, true);
          try {
            await App.request(App.urls.createBranch, {
              method: "POST",
              body: App.serializeForm("branchFormAdd"),
            });

            App.showAlert("Branch created successfully!", "success");
            setTimeout(() => location.reload(), 800);
          } catch (e) {
            App.showAlert(`Error: ${e.message}`, "error");
          } finally {
            App.setLoading(btn, false);
          }
        },

        async load(id) {
          try {
            const data = await App.request(App.urls.branchDetail(id));
            document.getElementById("branchIdEdit").value = data.id;
            document.getElementById("branchNameEdit").value = data.name || "";
            document.getElementById("branchPhoneEdit").value =
              data.phone_number || "";
            document.getElementById("branchEmailEdit").value =
              data.Email_Adress || "";
            document.getElementById("branchAddressEdit").value =
              data.address || "";
            document.getElementById("branchLatitudeEdit").value =
              data.latitude || "";
            document.getElementById("branchLongitudeEdit").value =
              data.longitude || "";
            document.getElementById("primaryBranchEdit").checked =
              !!data.primery_branch;

            // Update map position if exists
            if (
              window.editBranchMap &&
              window.editBranchMarker &&
              data.latitude &&
              data.longitude
            ) {
              const pos = {
                lat: parseFloat(data.latitude),
                lng: parseFloat(data.longitude),
              };
              window.editBranchMap.setCenter(pos);
              window.editBranchMap.setZoom(12);
              window.editBranchMarker.setPosition(pos);
            }

            App.openModal("editBranchModal");
          } catch (e) {
            App.showAlert("Failed to load branch data", "error");
          }
        },

        async update() {
          const btn = document.getElementById("updateBranchBtn");
          const form = document.getElementById("branchFormEdit");
          const id = document.getElementById("branchIdEdit")?.value;

          if (!form || !id || !form.checkValidity()) {
            form?.classList.add("was-validated");
            return;
          }

          App.setLoading(btn, true);
          try {
            const fd = new FormData(form);
            const cb = form.querySelector('[name="primery_branch"]');
            if (cb) fd.set("primery_branch", cb.checked ? "true" : "false");

            await App.request(App.urls.branchUpdate(id), {
              method: "POST",
              body: fd,
              isFormData: true,
            });

            App.showAlert("Branch updated successfully!", "success");
            setTimeout(() => location.reload(), 800);
          } catch (e) {
            App.showAlert(`Error: ${e.message}`, "error");
          } finally {
            App.setLoading(btn, false);
          }
        },

        async delete(id, btnEl) {
          const data = await App.request(App.urls.branchDelete(id), {
            method: "POST",
          });
          if (data.success) {
            btnEl?.closest("tr")?.remove();
            App.showAlert("Branch deleted successfully!", "success");
          }
        },
      },

      categories: {
        async create() {
          const btn = document.getElementById("createCategoryBtn");
          const form = document.getElementById("categoryFormAdd");
          if (!form || !form.checkValidity()) {
            form?.classList.add("was-validated");
            return;
          }

          App.setLoading(btn, true);
          try {
            const fd = new FormData(form);
            await App.request(App.urls.createCategory, {
              method: "POST",
              body: fd,
              isFormData: true,
            });
            App.showAlert("Category created successfully!", "success");
            setTimeout(() => location.reload(), 800);
          } catch (e) {
            App.showAlert(`Error: ${e.message}`, "error");
          } finally {
            App.setLoading(btn, false);
          }
        },

        loadFromDataset(btn) {
          document.getElementById("categoryIdEdit").value =
            btn.dataset.categoryId;
          document.getElementById("categoryNameEdit").value =
            btn.dataset.categoryName || "";
          document.getElementById("categoryDescriptionEdit").value =
            btn.dataset.categoryDescription || "";

          const preview = document.getElementById("categoryImagePreview");
          if (btn.dataset.categoryImage) {
            preview.src = btn.dataset.categoryImage;
            preview.style.display = "block";
          } else {
            preview.style.display = "none";
          }

          App.openModal("editCategoryModal");
        },

        async update() {
          const btn = document.getElementById("updateCategoryBtn");
          const form = document.getElementById("categoryFormEdit");
          const id = document.getElementById("categoryIdEdit")?.value;

          if (!form || !id || !form.checkValidity()) {
            form?.classList.add("was-validated");
            return;
          }

          App.setLoading(btn, true);
          try {
            const fd = new FormData(form);
            const data = await App.request(App.urls.categoryUpdate(id), {
              method: "POST",
              body: fd,
              isFormData: true,
            });

            if (data.success) {
              App.showAlert("Category updated successfully!", "success");
              setTimeout(() => location.reload(), 800);
            } else {
              App.showAlert(data.error || "Failed to update category", "error");
            }
          } catch (e) {
            App.showAlert(`Error: ${e.message}`, "error");
          } finally {
            App.setLoading(btn, false);
          }
        },

        async delete(id, btnEl) {
          const data = await App.request(App.urls.categoryDelete(id), {
            method: "POST",
          });
          if (data.success) {
            btnEl?.closest("tr")?.remove();
            App.showAlert("Category deleted successfully!", "success");
          }
        },
      },

      cities: {
        async create() {
          const btn = document.getElementById("createCityBtn");
          const form = document.getElementById("cityFormAdd");
          if (!form || !form.checkValidity()) {
            form?.classList.add("was-validated");
            return;
          }

          App.setLoading(btn, true);
          try {
            const payload = App.serializeForm("cityFormAdd");
            const data = await App.request(App.urls.createCity, {
              method: "POST",
              body: payload,
            });

            if (data.success) {
              App.showAlert("City created successfully!", "success");
              setTimeout(() => location.reload(), 800);
            } else {
              App.showAlert(data.error || "Failed to create city", "error");
            }
          } catch (e) {
            App.showAlert(`Error: ${e.message}`, "error");
          } finally {
            App.setLoading(btn, false);
          }
        },

        async load(id) {
          try {
            const data = await App.request(App.urls.cityDetail(id));
            document.getElementById("cityIdEdit").value = data.id;
            document.getElementById("cityNameEdit").value = data.name || "";
            document.getElementById("cityDeliveryFeeEdit").value =
              data.delivery_fee ?? "0.00";
            App.openModal("editCityModal");
          } catch (e) {
            App.showAlert("Failed to load city data", "error");
          }
        },

        async update() {
          const btn = document.getElementById("updateCityBtn");
          const form = document.getElementById("cityFormEdit");
          const id = document.getElementById("cityIdEdit")?.value;

          if (!form || !id || !form.checkValidity()) {
            form?.classList.add("was-validated");
            return;
          }

          App.setLoading(btn, true);
          try {
            const payload = App.serializeForm("cityFormEdit");
            const data = await App.request(App.urls.cityUpdate(id), {
              method: "POST",
              body: payload,
            });

            if (data.success) {
              App.showAlert("City updated successfully!", "success");
              setTimeout(() => location.reload(), 800);
            } else {
              App.showAlert(data.error || "Failed to update city", "error");
            }
          } catch (e) {
            App.showAlert(`Error: ${e.message}`, "error");
          } finally {
            App.setLoading(btn, false);
          }
        },

        async delete(id, btnEl) {
          const data = await App.request(App.urls.cityDelete(id), {
            method: "POST",
          });
          if (data.success) {
            btnEl?.closest("tr")?.remove();
            App.showAlert("City deleted successfully!", "success");
          }
        },
      },

      brands: {
        async create() {
          const btn = document.getElementById("createBrandBtn");
          const form = document.getElementById("brandFormAdd");
          if (!form || !form.checkValidity()) {
            form?.classList.add("was-validated");
            return;
          }

          App.setLoading(btn, true);
          try {
            const fd = new FormData(form);
            const data = await App.request(App.urls.createBrand, {
              method: "POST",
              body: fd,
              isFormData: true,
            });
            App.showAlert("Brand created successfully!", "success");
            App.closeModal("addBrandModal");
            setTimeout(() => location.reload(), 800);
          } catch (e) {
            App.showAlert(`Error: ${e.message}`, "error");
          } finally {
            App.setLoading(btn, false);
          }
        },

        loadFromDataset(btn) {
          document.getElementById("brandIdEdit").value = btn.dataset.brandId;
          document.getElementById("brandNameEdit").value =
            btn.dataset.brandName || "";
          document.getElementById("brandDescriptionEdit").value =
            btn.dataset.brandDescription || "";

          const preview = document.getElementById("brandImagePreview");
          if (btn.dataset.brandImage && btn.dataset.brandImage.trim() !== "") {
            preview.src = btn.dataset.brandImage;
            preview.style.display = "block";
          } else preview.style.display = "none";

          App.openModal("editBrandModal");
        },

        async update() {
          const btn = document.getElementById("updateBrandBtn");
          const form = document.getElementById("brandFormEdit");
          const id = document.getElementById("brandIdEdit")?.value;

          if (!form || !id || !form.checkValidity()) {
            form?.classList.add("was-validated");
            return;
          }

          App.setLoading(btn, true);
          try {
            const fd = new FormData(form);
            const data = await App.request(App.urls.brandUpdate(id), {
              method: "POST",
              body: fd,
              isFormData: true,
            });

            if (data.success) {
              App.showAlert("Brand updated successfully!", "success");
              App.closeModal("editBrandModal");
              setTimeout(() => location.reload(), 800);
            } else {
              App.showAlert(data.error || "Failed to update brand", "error");
            }
          } catch (e) {
            App.showAlert(`Error: ${e.message}`, "error");
          } finally {
            App.setLoading(btn, false);
          }
        },

        async delete(id, btnEl) {
          const data = await App.request(App.urls.brandDelete(id), {
            method: "POST",
          });
          if (data.success) {
            btnEl?.closest("tr")?.remove();
            App.showAlert("Brand deleted successfully!", "success");
          }
        },
      },

      banners: {
        async create() {
          const btn = document.getElementById("createBannerBtn");
          const form = document.getElementById("bannerFormAdd");
          if (!form || !form.checkValidity()) {
            form?.classList.add("was-validated");
            return;
          }

          App.setLoading(btn, true);
          try {
            const fd = new FormData(form);
            await App.request(App.urls.bannerAdd, {
              method: "POST",
              body: fd,
              isFormData: true,
            });
            App.showAlert("Banner created!", "success");
            setTimeout(() => location.reload(), 800);
          } catch (e) {
            App.showAlert(e.message, "error");
          } finally {
            App.setLoading(btn, false);
          }
        },

        async load(id) {
          try {
            const data = await App.request(App.urls.bannerDetail(id));

            document.getElementById("bannerIdEdit").value = data.id;
            document.getElementById("bannerTitleEdit").value = data.title || "";
            document.getElementById("bannerSubtitleEdit").value =
              data.subtitle || "";
            document.getElementById("bannerButtonTextEdit").value =
              data.button_text || "";
            document.getElementById("bannerButtonLinkEdit").value =
              data.button_link || "";
            document.getElementById("bannerColorEdit").value =
              data.text_color || "white";
            document.getElementById("bannerOrderEdit").value = data.order ?? 0;
            document.getElementById("bannerActiveEdit").checked =
              !!data.is_active;

            const preview = document.getElementById("bannerImagePreview");
            if (data.image_url) {
              preview.src = data.image_url;
              preview.style.display = "block";
            } else preview.style.display = "none";

            App.openModal("editBannerModal");
          } catch (e) {
            App.showAlert("Failed to load banner", "error");
          }
        },

        async update() {
          const btn = document.getElementById("updateBannerBtn");
          const form = document.getElementById("bannerFormEdit");
          const id = document.getElementById("bannerIdEdit")?.value;

          if (!form || !id || !form.checkValidity()) {
            form?.classList.add("was-validated");
            return;
          }

          App.setLoading(btn, true);
          try {
            const fd = new FormData(form);
            await App.request(App.urls.bannerUpdate(id), {
              method: "POST",
              body: fd,
              isFormData: true,
            });

            App.showAlert("Banner updated!", "success");
            setTimeout(() => location.reload(), 800);
          } catch (e) {
            App.showAlert(e.message, "error");
          } finally {
            App.setLoading(btn, false);
          }
        },

        async delete(id, btnEl) {
          const data = await App.request(App.urls.bannerDelete(id), {
            method: "POST",
          });
          if (data.success) {
            btnEl?.closest("tr")?.remove();
            App.showAlert("Banner deleted", "success");
          }
        },
      },

      messages: {
        view(message, email) {
          const e = document.getElementById("messageEmail");
          const c = document.getElementById("messageContent");
          if (e) e.textContent = email || "";
          if (c) c.textContent = message || "";
        },
      },

      // ====== PROJECTS (DRF CRUD) ======
      projects: {
        gridEl() {
          return document.getElementById("projectsGrid");
        },
        modal() {
          const el = document.getElementById("projectModal");
          return el ? new bootstrap.Modal(el) : null;
        },
        setModalTitle(t) {
          const el = document.getElementById("projectModalTitle");
          if (el) el.textContent = t;
        },
        formEl() {
          return document.getElementById("projectForm");
        },
        errorsEl() {
          return document.getElementById("projectFormErrors");
        },
        submitBtn() {
          return document.getElementById("projectSubmitBtn");
        },
        fields() {
          return {
            id: document.getElementById("projectId"),
            title: document.getElementById("title"),
            year: document.getElementById("year"),
            project_type: document.getElementById("project_type"),
            industry: document.getElementById("industry"),
            sort_order: document.getElementById("sort_order"),
            stack: document.getElementById("stack"),
            url: document.getElementById("url"),
            description: document.getElementById("description"),
            image: document.getElementById("image"),
            is_featured: document.getElementById("is_featured"),
            is_public: document.getElementById("is_public"),
          };
        },

        async fetch() {
          const grid = this.gridEl();
          if (!grid) return;

          try {
            const res = await fetch(App.urls.projectsBase, {
              headers: { Accept: "application/json" },
            });
            if (!res.ok) throw new Error("Failed to load projects");
            const data = await res.json();

            const items = Array.isArray(data) ? data : data.results || [];
            if (!items.length) {
              grid.innerHTML = `
                <div class="col-12 text-center">
                  <div class="modern-card p-5">
                    <i class="fas fa-folder-open fa-3x text-muted mb-3"></i>
                    <h4 class="text-muted mb-1">No Projects Yet</h4>
                    <p class="text-muted mb-0">Add your first SITEX project.</p>
                  </div>
                </div>
              `;
              return;
            }

            grid.innerHTML = items.map(this.cardHtml).join("");
          } catch (e) {
            console.error(e);
            App.showAlert(
              "Failed to load projects. Check API route & permissions.",
              "error"
            );
          }
        },

        cardHtml(p) {
          const img = p.image || p.image_url || "";
          const esc = App.escapeHtml;
          const isFeatured = !!p.is_featured;
          const isPublic = !!p.is_public;

          return `
            <div class="col-lg-4 col-md-6">
              <div class="modern-card project-card h-100">
                <div class="project-thumb">
                  ${
                    img
                      ? `<img src="${img}" alt="${esc(p.title)}">`
                      : `<div class="text-center p-4">
                          <i class="fas fa-code fa-3x text-muted mb-2"></i>
                          <div class="text-muted small">No image</div>
                        </div>`
                  }
                </div>

                <div class="p-4">
                  <div class="d-flex justify-content-between align-items-start gap-2">
                    <h5 class="fw-bold mb-2">${esc(p.title)}</h5>
                    <div class="project-actions d-flex gap-2">
                      <button class="btn btn-outline-primary btn-sm"
                        data-project-action="edit"
                        data-project-id="${p.id}">
                        <i class="fas fa-pen"></i>
                      </button>

                      <button class="btn btn-outline-danger btn-sm"
                        data-project-action="delete"
                        data-project-id="${p.id}">
                        <i class="fas fa-trash"></i>
                      </button>
                    </div>
                  </div>

                  <div class="project-badges mb-3 mt-1">
                    ${
                      isFeatured
                        ? `<span class="badge bg-primary">Featured</span>`
                        : ""
                    }
                    <span class="badge bg-secondary bg-opacity-10 text-secondary">
                      ${esc(p.project_type || "Project")}
                    </span>
                    ${
                      p.year
                        ? `<span class="badge bg-info bg-opacity-10 text-info">${p.year}</span>`
                        : ""
                    }
                    <span class="badge ${
                      isPublic
                        ? "bg-success bg-opacity-10 text-success"
                        : "bg-danger bg-opacity-10 text-danger"
                    }">
                      ${isPublic ? "Public" : "Private"}
                    </span>
                  </div>

                  ${
                    p.description
                      ? `<p class="text-muted mb-3">${esc(p.description).slice(
                          0,
                          160
                        )}${p.description.length > 160 ? "..." : ""}</p>`
                      : `<p class="text-muted mb-3"><span class="text-muted">No description</span></p>`
                  }

                  ${
                    p.stack
                      ? `<div class="small text-muted mb-3"><i class="fas fa-layer-group me-1"></i>${esc(
                          p.stack
                        )}</div>`
                      : ""
                  }

                  ${
                    p.url
                      ? `<a href="${p.url}" target="_blank" rel="noopener" class="btn btn-outline-primary btn-sm btn-modern">
                    <i class="fas fa-external-link-alt me-1"></i>Open
                  </a>`
                      : ""
                  }
                </div>
              </div>
            </div>
          `;
        },

        resetForm() {
          const form = this.formEl();
          const f = this.fields();
          if (!form) return;

          this.errorsEl().innerHTML = "";
          form.reset();
          f.id.value = "";
          f.sort_order.value = 0;
          f.is_public.checked = true;
          f.is_featured.checked = false;
          f.image.value = "";
        },

        openCreate() {
          this.resetForm();
          this.setModalTitle("Add Project");
          this.modal()?.show();
        },

        async openEdit(id) {
          this.resetForm();
          this.setModalTitle("Edit Project");
          const f = this.fields();

          try {
            const res = await fetch(App.urls.projectDetail(id), {
              headers: { Accept: "application/json" },
            });
            if (!res.ok) throw new Error("Failed to load project");
            const p = await res.json();

            f.id.value = p.id;
            f.title.value = p.title || "";
            f.year.value = p.year || "";
            f.project_type.value = p.project_type || "";
            f.industry.value = p.industry || "";
            f.sort_order.value = p.sort_order ?? 0;
            f.stack.value = p.stack || "";
            f.url.value = p.url || "";
            f.description.value = p.description || "";
            f.is_featured.checked = !!p.is_featured;
            f.is_public.checked = !!p.is_public;

            this.modal()?.show();
          } catch (e) {
            App.showAlert("Failed to open project for editing.", "error");
          }
        },

        buildFormData() {
          const f = this.fields();
          const fd = new FormData();

          fd.append("title", (f.title.value || "").trim());
          fd.append("description", (f.description.value || "").trim());
          fd.append("url", (f.url.value || "").trim());
          fd.append("project_type", (f.project_type.value || "").trim());
          fd.append("stack", (f.stack.value || "").trim());
          fd.append("industry", (f.industry.value || "").trim());
          fd.append("sort_order", f.sort_order.value || "0");
          fd.append("is_featured", f.is_featured.checked ? "true" : "false");
          fd.append("is_public", f.is_public.checked ? "true" : "false");
          if (f.year.value) fd.append("year", f.year.value);

          if (f.image.files && f.image.files[0])
            fd.append("image", f.image.files[0]);

          return fd;
        },

        renderErrors(errJson) {
          const el = this.errorsEl();
          let html = "";
          for (const key in errJson) {
            const msgs = Array.isArray(errJson[key])
              ? errJson[key].join(", ")
              : String(errJson[key]);
            html += `<div><i class="fas fa-exclamation-circle me-1"></i><b>${App.escapeHtml(
              key
            )}:</b> ${App.escapeHtml(msgs)}</div>`;
          }
          el.innerHTML = html || "Validation error.";
        },

        setSaving(isSaving) {
          const btn = this.submitBtn();
          if (!btn) return;
          btn.disabled = isSaving;
          btn.innerHTML = isSaving
            ? `<span class="spinner-border spinner-border-sm me-2"></span>Saving...`
            : `<i class="fas fa-save me-2"></i>Save`;
        },

        async submit(e) {
          e.preventDefault();

          const f = this.fields();
          const id = f.id.value;
          this.errorsEl().innerHTML = "";

          try {
            this.setSaving(true);
            const fd = this.buildFormData();

            const res = await fetch(
              id ? App.urls.projectDetail(id) : App.urls.projectsBase,
              {
                method: id ? "PATCH" : "POST",
                headers: { "X-CSRFToken": App.csrfToken },
                body: fd,
                credentials: "same-origin",
              }
            );

            const data = await res.json().catch(() => ({}));

            if (!res.ok) {
              this.renderErrors(data);
              throw new Error("Save failed");
            }

            App.showAlert(
              id
                ? "Project updated successfully."
                : "Project created successfully.",
              "success"
            );
            this.modal()?.hide();
            await this.fetch();
          } catch (err) {
            if (err.message !== "Save failed")
              App.showAlert(err.message, "error");
          } finally {
            this.setSaving(false);
          }
        },

        async delete(id) {
          try {
            const res = await fetch(App.urls.projectDetail(id), {
              method: "DELETE",
              headers: { "X-CSRFToken": App.csrfToken },
              credentials: "same-origin",
            });

            if (!res.ok) throw new Error("Delete failed (check permissions)");
            App.showAlert("Project deleted successfully.", "success");
            await this.fetch();
          } catch (e) {
            App.showAlert(e.message, "error");
          }
        },
      },
    };

    // Expose initBranchMaps callback globally for Google Maps
    window.initBranchMaps = function () {
      // --- ADD BRANCH MAP ---
      const addMapEl = document.getElementById("branchMapAdd");
      if (addMapEl) {
        const defaultLatLng = { lat: 0, lng: 0 };

        window.addBranchMap = new google.maps.Map(addMapEl, {
          center: defaultLatLng,
          zoom: 2,
        });

        window.addBranchMarker = new google.maps.Marker({
          position: defaultLatLng,
          map: window.addBranchMap,
          draggable: true,
        });

        window.addBranchMarker.addListener("dragend", function () {
          document.getElementById("branchLatitudeAdd").value =
            window.addBranchMarker.getPosition().lat().toFixed(6);
          document.getElementById("branchLongitudeAdd").value =
            window.addBranchMarker.getPosition().lng().toFixed(6);
        });

        window.addBranchMap.addListener("click", function (e) {
          window.addBranchMarker.setPosition(e.latLng);
          document.getElementById("branchLatitudeAdd").value = e.latLng
            .lat()
            .toFixed(6);
          document.getElementById("branchLongitudeAdd").value = e.latLng
            .lng()
            .toFixed(6);
        });
      }

      // --- EDIT BRANCH MAP ---
      const editMapEl = document.getElementById("branchMapEdit");
      if (editMapEl) {
        const defaultLatLng = { lat: 0, lng: 0 };

        window.editBranchMap = new google.maps.Map(editMapEl, {
          center: defaultLatLng,
          zoom: 2,
        });

        window.editBranchMarker = new google.maps.Marker({
          position: defaultLatLng,
          map: window.editBranchMap,
          draggable: true,
        });

        window.editBranchMarker.addListener("dragend", function () {
          document.getElementById("branchLatitudeEdit").value =
            window.editBranchMarker.getPosition().lat().toFixed(6);
          document.getElementById("branchLongitudeEdit").value =
            window.editBranchMarker.getPosition().lng().toFixed(6);
        });

        window.editBranchMap.addListener("click", function (e) {
          window.editBranchMarker.setPosition(e.latLng);
          document.getElementById("branchLatitudeEdit").value = e.latLng
            .lat()
            .toFixed(6);
          document.getElementById("branchLongitudeEdit").value = e.latLng
            .lng()
            .toFixed(6);
        });
      }
    };

    // Start app
    App.init();
  });
</script>
<!-- prettier-ignore-end -->

<!-- prettier-ignore-start -->
<script>
  // ✅ MUST be global for Google callback
  window.initBranchMaps = function () {
    let addBranchMap, addBranchMarker;
    let editBranchMap, editBranchMarker;

    // --- ADD BRANCH MAP ---
    const addMapEl = document.getElementById("branchMapAdd");
    if (addMapEl) {
      const defaultLatLng = { lat: 0, lng: 0 };
      addBranchMap = new google.maps.Map(addMapEl, {
        center: defaultLatLng,
        zoom: 2,
      });

      addBranchMarker = new google.maps.Marker({
        position: defaultLatLng,
        map: addBranchMap,
        draggable: true,
      });

      addBranchMarker.addListener("dragend", function () {
        document.getElementById("branchLatitudeAdd").value = addBranchMarker
          .getPosition()
          .lat()
          .toFixed(6);
        document.getElementById("branchLongitudeAdd").value = addBranchMarker
          .getPosition()
          .lng()
          .toFixed(6);
      });

      addBranchMap.addListener("click", function (e) {
        addBranchMarker.setPosition(e.latLng);
        document.getElementById("branchLatitudeAdd").value = e.latLng
          .lat()
          .toFixed(6);
        document.getElementById("branchLongitudeAdd").value = e.latLng
          .lng()
          .toFixed(6);
      });
    }

    // --- EDIT BRANCH MAP ---
    const editMapEl = document.getElementById("branchMapEdit");
    if (editMapEl) {
      const defaultLatLng = { lat: 0, lng: 0 };
      editBranchMap = new google.maps.Map(editMapEl, {
        center: defaultLatLng,
        zoom: 2,
      });

      editBranchMarker = new google.maps.Marker({
        position: defaultLatLng,
        map: editBranchMap,
        draggable: true,
      });

      editBranchMarker.addListener("dragend", function () {
        document.getElementById("branchLatitudeEdit").value = editBranchMarker
          .getPosition()
          .lat()
          .toFixed(6);
        document.getElementById("branchLongitudeEdit").value = editBranchMarker
          .getPosition()
          .lng()
          .toFixed(6);
      });

      editBranchMap.addListener("click", function (e) {
        editBranchMarker.setPosition(e.latLng);
        document.getElementById("branchLatitudeEdit").value = e.latLng
          .lat()
          .toFixed(6);
        document.getElementById("branchLongitudeEdit").value = e.latLng
          .lng()
          .toFixed(6);
      });
    }
  };
  // ====== MODAL BACKDROP SAFETY NET ======
  document.addEventListener(
    "hidden.bs.modal",
    function () {
      if (document.querySelectorAll(".modal.show").length === 0) {
        document.body.classList.remove("modal-open");
        document.body.style.removeProperty("padding-right");
        document.body.style.removeProperty("overflow");
        document.querySelectorAll(".modal-backdrop").forEach((b) => b.remove());
      }
    },
    true
  );
</script>
<!-- prettier-ignore-end -->

<!-- prettier-ignore-start -->
<script
  async
  defer
  src="https://maps.googleapis.com/maps/api/js?key=YOUR_KEY&callback=initBranchMaps"
></script>
<!-- prettier-ignore-end -->
<style>
  /* Dashboard Container */
  .dashboard-container {
    padding: 1rem;
    min-height: 100vh;
  }

  /* Stats Cards - Mobile Responsive */
  .stats-card {
    border-radius: 12px;
    padding: 1rem;
    display: flex;
    align-items: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    transition: transform 0.3s ease;
    margin-bottom: 1rem;
  }

  .stats-card:hover {
    transform: translateY(-5px);
  }

  .stats-icon {
    font-size: 1.5rem;
    margin-right: 0.75rem;
    opacity: 0.9;
  }

  .stats-number {
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
  }

  .stats-label {
    font-size: 0.8rem;
    opacity: 0.9;
    margin-bottom: 0;
  }

  /* Section Headers */
  .section-header {
    padding: 0.75rem 0;
    border-bottom: 1px solid var(--card-border-color, #dee2e6);
    margin-bottom: 1rem;
  }

  .section-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 0;
  }

  .project-card {
    transition: all 0.25s ease;
  }
  .project-card:hover {
    transform: translateY(-6px);
  }

  .project-thumb {
    height: 200px;
    border-radius: 14px 14px 0 0;
    overflow: hidden;
    background: rgba(0, 0, 0, 0.03);
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .project-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  .project-badges {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }

  .project-actions .btn {
    padding: 0.35rem 0.6rem;
    border-radius: 10px;
  }

  /* Tables - Mobile Responsive */
  .modern-card {
    background: var(--card-bg, #fff);
    border-radius: 12px;
    border: 1px solid var(--card-border-color, #dee2e6);
    overflow: hidden;
    margin-bottom: 1.5rem;
  }

  .table-responsive {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .table {
    margin-bottom: 0;
    width: 100%;
  }

  .table th {
    white-space: nowrap;
    font-size: 0.875rem;
  }

  .table td {
    vertical-align: middle;
    padding: 0.75rem;
  }

  /* Mobile-specific table adjustments */
  @media (max-width: 767.98px) {
    .table td,
    .table th {
      padding: 0.5rem;
      font-size: 0.875rem;
    }

    .table .btn-group-sm .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }

    .product-thumbnail {
      width: 40px;
      height: 40px;
    }

    .user-avatar {
      width: 30px;
      height: 30px;
      font-size: 0.75rem;
    }

    .text-truncate {
      max-width: 100px !important;
    }
  }

  /* Product Thumbnail */
  .product-thumbnail {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid var(--card-border-color, #dee2e6);
  }

  .no-image-placeholder {
    width: 50px;
    height: 50px;
    border-radius: 8px;
    background: var(--card-bg, #f8f9fa);
    display: flex;
    align-items: center;
    justify-content: center;
    border: 1px dashed var(--card-border-color, #dee2e6);
    color: var(--text-muted, #6c757d);
  }

  /* User Avatar */
  .user-avatar {
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
    font-size: 0.875rem;
  }

  /* Buttons */
  .btn-modern {
    transition: all 0.3s ease;
    border-radius: 8px;
  }

  .btn-modern:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .btn-primary-modern {
    background: linear-gradient(135deg, var(--primary, #0d6efd), #0a58ca);
    border: none;
    color: white;
  }

  .btn-success-modern {
    background: linear-gradient(135deg, var(--success, #198754), #146c43);
    border: none;
    color: white;
  }

  .btn-warning-modern {
    background: linear-gradient(135deg, var(--warning, #ffc107), #e0a800);
    border: none;
    color: white;
  }

  /* Modals - Mobile Responsive */
  .modal-dialog {
    margin: 0.5rem;
  }

  .modal-content {
    border-radius: 12px;
    border: 1px solid var(--card-border-color, #dee2e6);
  }

  .modal-header {
    border-radius: 12px 12px 0 0;
    padding: 1rem;
  }

  .modal-title {
    font-size: 1.1rem;
    font-weight: 600;
  }

  .modal-body {
    padding: 1rem;
    max-height: 70vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }

  .modal-footer {
    padding: 1rem;
    border-top: 1px solid var(--card-border-color, #dee2e6);
  }

  /* Form Elements */
  .form-floating {
    margin-bottom: 1rem;
  }

  .form-floating > .form-control,
  .form-floating > .form-select {
    height: calc(3.5rem + 2px);
    min-height: calc(3.5rem + 2px);
  }

  .form-floating > label {
    padding: 1rem 0.75rem;
  }

  /* Checkbox and Radio styling */
  .form-check {
    margin-bottom: 0.5rem;
  }

  /* Badges */
  .badge {
    font-size: 0.75em;
    padding: 0.35em 0.65em;
    font-weight: 600;
  }

  /* Alert Styling */
  .dashboard-alert {
    /* positioning is now handled inline in JS */
    z-index: 9999;
    min-width: 280px;
    max-width: 400px;
    border-radius: 8px;
    animation: fadeInScale 0.25s ease;
  }

  @keyframes fadeInScale {
    from {
      transform: translate(-50%, -50%) scale(0.9);
      opacity: 0;
    }
    to {
      transform: translate(-50%, -50%) scale(1);
      opacity: 1;
    }
  }

  /* Mobile-specific styles */
  @media (max-width: 767.98px) {
    /* Dashboard header */
    .dashboard-header .row {
      flex-direction: column;
    }

    .dashboard-header .text-md-end {
      text-align: left !important;
      margin-top: 1rem;
    }

    .dashboard-header .d-flex {
      flex-direction: column;
      gap: 0.5rem;
    }

    .dashboard-header .btn {
      width: 100%;
    }

    /* Stats cards */
    .stats-card {
      padding: 0.75rem;
    }

    .stats-icon {
      font-size: 1.25rem;
      margin-right: 0.5rem;
    }

    .stats-number {
      font-size: 1.25rem;
    }

    /* Section headers */
    .section-header {
      flex-direction: column;
      align-items: flex-start !important;
      gap: 0.5rem;
    }

    .section-header .btn {
      align-self: stretch;
    }

    /* Modals */
    .modal-dialog {
      margin: 0.5rem;
    }

    .modal-content {
      margin: 0;
    }

    .modal-body {
      padding: 0.75rem;
      max-height: 60vh;
    }

    /* Forms in modals */
    .form-floating > .form-control,
    .form-floating > .form-select {
      height: calc(3rem + 2px);
      min-height: calc(3rem + 2px);
    }

    .row.g-3 > [class*="col-"] {
      padding-right: calc(var(--bs-gutter-x) * 0.5);
      padding-left: calc(var(--bs-gutter-x) * 0.5);
    }

    /* Buttons */
    .btn-group {
      flex-wrap: nowrap;
    }

    .btn-group .btn {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
    }
  }

  /* Tablet styles */
  @media (min-width: 768px) and (max-width: 991.98px) {
    .stats-card {
      padding: 1rem;
    }

    .modal-dialog.modal-lg {
      max-width: 90%;
    }
  }

  /* Dark mode support */
  @media (prefers-color-scheme: dark) {
    .modern-modal .modal-content {
      background-color: var(--card-bg, #2d3748);
      color: var(--text-color, #e2e8f0);
    }

    .table {
      color: var(--text-color, #e2e8f0);
    }

    .table-hover tbody tr:hover {
      background-color: rgba(255, 255, 255, 0.05);
    }

    .form-control,
    .form-select {
      background-color: var(--card-bg, #2d3748);
      border-color: var(--card-border-color, #4a5568);
      color: var(--text-color, #e2e8f0);
    }

    .form-control:focus,
    .form-select:focus {
      background-color: var(--card-bg, #2d3748);
      border-color: var(--primary, #4299e1);
      color: var(--text-color, #e2e8f0);
    }

    .form-check-input {
      background-color: var(--card-bg, #2d3748);
      border-color: var(--card-border-color, #4a5568);
    }
  }

  /* Print styles */
  @media print {
    .dashboard-container {
      padding: 0;
    }

    .btn,
    .modal,
    .dashboard-alert {
      display: none !important;
    }

    .modern-card {
      border: 1px solid #000;
      box-shadow: none;
    }

    .table {
      border: 1px solid #000;
    }

    .table th,
    .table td {
      border: 1px solid #000;
    }
  }
  @media (min-width: 576px) {
    .modal.show .modal-dialog.modal-dialog-centered {
      margin: 0;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-height: 90vh;
    }

    .modal.show .modal-dialog.modal-dialog-centered .modal-content {
      max-height: 90vh;
      overflow-y: auto;
    }
  }
</style>
{% endblock %}
