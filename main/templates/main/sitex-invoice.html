{% extends "main/base.html" %}
{% load i18n %}
<!-- prettier-ignore -->
{% block title %}
{% trans "فاتورة - SITEX" %}
{% endblock %}

{% block content %}
<section class="min-h-screen bg-gradient-to-br from-gray-50 to-gray-100 py-8 px-4 sm:px-6 lg:px-8" dir="rtl">
  <div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
      <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200">
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-6">
          <div>
            <h1 class="text-2xl font-bold text-gray-900 mb-2">
              <i class="fas fa-file-invoice text-blue-600 ml-2"></i>
              {% trans "إنشاء فاتورة" %}
            </h1>
            <p class="text-gray-600 text-sm">
              {% trans "املأ البيانات واختر الخدمات لإنشاء فاتورة احترافية" %}
            </p>
          </div>
          <div class="flex gap-3 flex-wrap">
            <button id="saveDraftBtn" class="px-6 py-3 bg-white border-2 border-gray-300 text-gray-700 font-semibold rounded-xl shadow-sm hover:bg-gray-50 hover:border-gray-400 transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-gray-300 focus:ring-offset-2">
              <i class="fas fa-save ml-2"></i>
              {% trans "حفظ كمسودة" %}
            </button>
            <button id="printBtn" class="px-6 py-3 bg-gradient-to-r from-blue-600 to-blue-700 text-white font-semibold rounded-xl shadow-lg hover:from-blue-700 hover:to-blue-800 transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
              <i class="fas fa-print ml-2"></i>
              {% trans "طباعة / حفظ PDF" %}
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-7 gap-6">
      <!-- Left Column - Forms -->
      <div class="lg:col-span-4 space-y-6">
        <!-- Basic Info Card -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200" style="animation: fadeIn 0.6s ease-out forwards; opacity: 0;">
          <div class="flex items-center mb-6">
            <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center ml-3">
              <i class="fas fa-info-circle text-blue-600"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">{% trans "المعلومات الأساسية" %}</h3>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "رقم الفاتورة" %}</label>
              <div class="relative">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                  <i class="fas fa-hashtag text-gray-400"></i>
                </div>
                <input id="invNumber" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 text-sm transition-all duration-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none placeholder-gray-400 pr-10" placeholder="INV-0001" value="INV-{{ now.year }}-001">
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "تاريخ الفاتورة" %}</label>
              <div class="relative">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                  <i class="fas fa-calendar text-gray-400"></i>
                </div>
                <input id="invDate" type="date" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 text-sm transition-all duration-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none placeholder-gray-400 pr-10">
              </div>
            </div>
          </div>
        </div>

        <!-- Client Info Card -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200" style="animation: fadeIn 0.6s ease-out 0.1s forwards; opacity: 0;">
          <div class="flex items-center mb-6">
            <div class="w-10 h-10 bg-indigo-50 rounded-lg flex items-center justify-center ml-3">
              <i class="fas fa-user-tie text-indigo-600"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">{% trans "معلومات العميل" %}</h3>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "اسم العميل" %}</label>
              <div class="relative">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                  <i class="fas fa-user text-gray-400"></i>
                </div>
                <input id="clientName" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 text-sm transition-all duration-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none placeholder-gray-400 pr-10" placeholder="{% trans 'اسم العميل' %}">
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "اسم الشركة" %}</label>
              <div class="relative">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                  <i class="fas fa-building text-gray-400"></i>
                </div>
                <input id="clientCompany" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 text-sm transition-all duration-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none placeholder-gray-400 pr-10" placeholder="{% trans 'الشركة / الجهة' %}">
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "البريد الإلكتروني" %}</label>
              <div class="relative">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                  <i class="fas fa-envelope text-gray-400"></i>
                </div>
                <input id="clientEmail" type="email" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 text-sm transition-all duration-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none placeholder-gray-400 pr-10" placeholder="client@email.com">
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "رقم الهاتف" %}</label>
              <div class="relative">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                  <i class="fas fa-phone text-gray-400"></i>
                </div>
                <input id="clientPhone" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 text-sm transition-all duration-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none placeholder-gray-400 pr-10" placeholder="09xxxxxxxx">
              </div>
            </div>
          </div>
        </div>

        <!-- Project Info Card -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200" style="animation: fadeIn 0.6s ease-out 0.2s forwards; opacity: 0;">
          <div class="flex items-center mb-6">
            <div class="w-10 h-10 bg-purple-50 rounded-lg flex items-center justify-center ml-3">
              <i class="fas fa-project-diagram text-purple-600"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">{% trans "معلومات المشروع" %}</h3>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "نوع المشروع" %}</label>
              <div class="relative">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                  <i class="fas fa-tags text-gray-400"></i>
                </div>
                <select id="projectType" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 text-sm transition-all duration-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none placeholder-gray-400 pr-10 appearance-none">
                  <option value="">{% trans "اختر نوع المشروع" %}</option>
                  <option value="website">{% trans "موقع ويب" %}</option>
                  <option value="ecommerce">{% trans "متجر إلكتروني" %}</option>
                  <option value="system">{% trans "نظام إدارة" %}</option>
                  <option value="mobile">{% trans "تطبيق جوال" %}</option>
                  <option value="design">{% trans "تصميم جرافيك" %}</option>
                </select>
              </div>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "اسم المشروع" %}</label>
              <div class="relative">
                <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                  <i class="fas fa-file-alt text-gray-400"></i>
                </div>
                <input id="projectName" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 text-sm transition-all duration-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none placeholder-gray-400 pr-10" placeholder="{% trans 'اسم المشروع' %}">
              </div>
            </div>
            
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "ملاحظات المشروع" %}</label>
              <textarea id="invNotes" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 text-sm transition-all duration-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none placeholder-gray-400 min-h-[100px]" rows="3" placeholder="{% trans 'أضف أي ملاحظات أو تفاصيل إضافية...' %}"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Column - Preview & Actions -->
      <div class="lg:col-span-3 space-y-6">
        <!-- Totals Card -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200" style="animation: fadeIn 0.6s ease-out 0.3s forwards; opacity: 0;">
          <div class="flex items-center mb-6">
            <div class="w-10 h-10 bg-green-50 rounded-lg flex items-center justify-center ml-3">
              <i class="fas fa-calculator text-green-600"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">{% trans "إجمالي الفاتورة" %}</h3>
          </div>
          
          <div class="space-y-4">
            <!-- Subtotal -->
            <div class="bg-gray-50 rounded-xl p-4 border border-gray-200 transition-all duration-300 hover:border-blue-300">
              <div class="flex justify-between items-center">
                <div>
                  <div class="text-sm text-gray-600">{% trans "الإجمالي الفرعي" %}</div>
                  <div class="text-2xl font-bold text-gray-900"><span id="invSubtotal">0</span> د.ل</div>
                </div>
                <div class="w-12 h-12 bg-blue-50 rounded-lg flex items-center justify-center">
                  <i class="fas fa-receipt text-blue-600 text-xl"></i>
                </div>
              </div>
            </div>
            
            <!-- Discount & Tax -->
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "خصم (د.ل)" %}</label>
                <div class="relative">
                  <input id="invDiscount" type="number" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 text-sm transition-all duration-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none placeholder-gray-400 text-left" value="0" min="0" step="1">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">د.ل</span>
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "ضريبة (د.ل)" %}</label>
                <div class="relative">
                  <input id="invTax" type="number" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 text-sm transition-all duration-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none placeholder-gray-400 text-left" value="0" min="0" step="1">
                  <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">د.ل</span>
                </div>
              </div>
            </div>
            
            <!-- Total -->
            <div class="bg-gradient-to-r from-blue-600 to-blue-700 rounded-xl p-5 text-white shadow-lg">
              <div class="flex justify-between items-center">
                <div>
                  <div class="text-sm opacity-90">{% trans "الإجمالي النهائي" %}</div>
                  <div class="text-3xl font-bold"><span id="invTotal">0</span> د.ل</div>
                </div>
                <i class="fas fa-wallet text-2xl opacity-90"></i>
              </div>
            </div>
            
            <!-- Payment Info -->
            <div class="pt-4 border-t border-gray-200">
              <label class="block text-sm font-medium text-gray-700 mb-2">{% trans "بيانات الدفع" %}</label>
              <textarea id="invPayInfo" class="w-full px-4 py-3 bg-white border border-gray-300 rounded-xl text-gray-900 text-sm transition-all duration-200 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 focus:outline-none placeholder-gray-400 min-h-[80px]" placeholder="{% trans 'مثال: تحويل مصرفي / نقدي / بيانات الحساب...' %}"></textarea>
            </div>
            
            <!-- Action Buttons -->
            <div class="space-y-3 pt-4">
              <button id="copyBtn" class="w-full px-6 py-3 bg-white border-2 border-blue-600 text-blue-600 font-semibold rounded-xl hover:bg-blue-50 hover:border-blue-700 hover:text-blue-700 transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                <i class="fas fa-copy ml-2"></i>
                {% trans "نسخ ملخص الفاتورة" %}
              </button>
              <button id="sendEmailBtn" class="w-full px-6 py-3 bg-gradient-to-r from-green-600 to-green-700 text-white font-semibold rounded-xl shadow-lg hover:from-green-700 hover:to-green-800 transform hover:-translate-y-0.5 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                <i class="fas fa-paper-plane ml-2"></i>
                {% trans "إرسال بالبريد الإلكتروني" %}
              </button>
            </div>
          </div>
        </div>
        
        <!-- Quick Templates -->
        <div class="bg-white rounded-2xl shadow-lg p-6 border border-gray-200" style="animation: fadeIn 0.6s ease-out 0.4s forwards; opacity: 0;">
          <div class="flex items-center mb-4">
            <div class="w-10 h-10 bg-yellow-50 rounded-lg flex items-center justify-center ml-3">
              <i class="fas fa-bolt text-yellow-600"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">{% trans "قوالب سريعة" %}</h3>
          </div>
          
          <p class="text-gray-600 text-sm mb-4">{% trans "اختر قالبًا لملء الخدمات تلقائيًا" %}</p>
          
          <div class="grid grid-cols-2 gap-3">
            <button class="template-btn px-4 py-3 bg-white border-2 border-gray-200 text-gray-700 font-medium rounded-lg hover:border-blue-300 hover:bg-blue-50 hover:text-blue-700 transition-all duration-200 focus:outline-none flex items-center justify-center" data-template="website">
              <i class="fas fa-globe ml-2"></i>
              {% trans "موقع ويب" %}
            </button>
            <button class="template-btn px-4 py-3 bg-white border-2 border-gray-200 text-gray-700 font-medium rounded-lg hover:border-blue-300 hover:bg-blue-50 hover:text-blue-700 transition-all duration-200 focus:outline-none flex items-center justify-center" data-template="ecommerce">
              <i class="fas fa-shopping-cart ml-2"></i>
              {% trans "متجر إلكتروني" %}
            </button>
            <button class="template-btn px-4 py-3 bg-white border-2 border-gray-200 text-gray-700 font-medium rounded-lg hover:border-blue-300 hover:bg-blue-50 hover:text-blue-700 transition-all duration-200 focus:outline-none flex items-center justify-center" data-template="maintenance">
              <i class="fas fa-tools ml-2"></i>
              {% trans "صيانة" %}
            </button>
            <button class="template-btn px-4 py-3 bg-white border-2 border-gray-200 text-gray-700 font-medium rounded-lg hover:border-blue-300 hover:bg-blue-50 hover:text-blue-700 transition-all duration-200 focus:outline-none flex items-center justify-center" data-template="custom">
              <i class="fas fa-plus ml-2"></i>
              {% trans "مخصص" %}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Services Table -->
    <div class="mt-8">
      <div class="bg-white rounded-2xl shadow-lg overflow-hidden border border-gray-200" style="animation: fadeIn 0.6s ease-out 0.5s forwards; opacity: 0;">
        <div class="px-6 py-5 border-b border-gray-200 bg-gradient-to-r from-gray-50 to-white">
          <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div>
              <h3 class="text-lg font-semibold text-gray-900 mb-1">
                <i class="fas fa-list-check text-blue-600 ml-2"></i>
                {% trans "الخدمات والبنود" %}
              </h3>
              <p class="text-gray-600 text-sm">{% trans "أضف وعدّل الخدمات المطلوبة" %}</p>
            </div>
            <div class="flex gap-3">
              <button id="addRowBtn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 text-sm font-medium rounded-lg hover:bg-gray-50 hover:border-gray-400 transition-all duration-200 focus:outline-none">
                <i class="fas fa-plus ml-2"></i>
                {% trans "إضافة بند" %}
              </button>
              <button id="clearAllBtn" class="px-4 py-2 bg-white border border-red-300 text-red-600 text-sm font-medium rounded-lg hover:bg-red-50 hover:border-red-400 transition-all duration-200 focus:outline-none">
                <i class="fas fa-trash ml-2"></i>
                {% trans "حذف الكل" %}
              </button>
            </div>
          </div>
        </div>
        
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="py-4 px-6 text-right font-semibold text-gray-700 w-[40%]">
                  <i class="fas fa-cube ml-2"></i>{% trans "الخدمة / الوصف" %}
                </th>
                <th class="py-4 px-6 text-center font-semibold text-gray-700 w-[15%]">
                  <i class="fas fa-hashtag ml-2"></i>{% trans "الكمية" %}
                </th>
                <th class="py-4 px-6 text-left font-semibold text-gray-700 w-[20%]">
                  <i class="fas fa-tag ml-2"></i>{% trans "سعر الوحدة" %}
                </th>
                <th class="py-4 px-6 text-left font-semibold text-gray-700 w-[20%]">
                  <i class="fas fa-calculator ml-2"></i>{% trans "الإجمالي" %}
                </th>
                <th class="py-4 px-6 text-center w-[5%]"></th>
              </tr>
            </thead>
            <tbody id="invItemsBody" class="divide-y divide-gray-200"></tbody>
          </table>
        </div>
        
        <div class="px-6 py-4 bg-gray-50 border-t border-gray-200">
          <div class="flex flex-col sm:flex-row justify-between items-center gap-2">
            <div class="text-sm text-gray-600">
              <i class="fas fa-circle-info ml-1"></i>
              {% trans "إجمالي البنود:" %} <span class="font-semibold" id="itemsCount">0</span>
            </div>
            <div class="text-sm text-gray-500">
              {% trans "سيتم تحديث الإجمالي تلقائيًا" %}
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Printable Invoice (Hidden) -->
<section id="printInvoice" class="hidden" aria-hidden="true" dir="rtl">
  <div class="max-w-[210mm] mx-auto p-8 bg-white">
    <!-- Header -->
    <div class="flex justify-between items-start pb-6 mb-6 border-b-2 border-blue-600">
      <div>
        <div class="text-3xl font-black text-blue-600 mb-2">SITEX</div>
        <div class="text-sm text-gray-600 leading-relaxed">
          {% trans "حلول البرمجيات وتقنية المعلومات" %}<br />
          {% trans "طرابلس - ليبيا" %}<br />
          info@sitex.com.ly
        </div>
      </div>
      <div class="text-4xl font-bold text-gray-900">{% trans "فاتورة" %}</div>
    </div>
    
    <!-- Meta Info -->
    <div class="grid grid-cols-2 gap-y-2 gap-x-8 text-sm mb-8" style="grid-template-columns: 120px 1fr;">
      <div class="text-gray-600 font-semibold text-left">{% trans "رقم الفاتورة" %}</div>
      <div class="text-gray-900 font-bold text-left" id="pInvNumber">—</div>
      <div class="text-gray-600 font-semibold text-left">{% trans "تاريخ الفاتورة" %}</div>
      <div class="text-gray-900 font-bold text-left" id="pInvDate">—</div>
      <div class="text-gray-600 font-semibold text-left">{% trans "نوع المشروع" %}</div>
      <div class="text-gray-900 font-bold text-left" id="pProjectType">—</div>
      <div class="text-gray-600 font-semibold text-left">{% trans "العملة" %}</div>
      <div class="text-gray-900 font-bold text-left">دينار ليبي (LYD)</div>
    </div>
    
    <!-- Client & Project Info -->
    <div class="grid grid-cols-2 gap-6 mb-8">
      <div>
        <h3 class="font-bold text-base text-gray-800 mb-3 pb-2 border-b border-gray-300">{% trans "فاتورة إلى" %}</h3>
        <div>
          <div class="font-bold text-lg mb-1" id="pClientName">—</div>
          <div class="text-gray-600 text-sm mb-1" id="pClientCompany">—</div>
          <div class="text-gray-600 text-sm">
            <span id="pClientEmail">—</span> | <span id="pClientPhone">—</span>
          </div>
        </div>
      </div>
      
      <div>
        <h3 class="font-bold text-base text-gray-800 mb-3 pb-2 border-b border-gray-300">{% trans "معلومات المشروع" %}</h3>
        <div>
          <div class="font-semibold text-base mb-2" id="pProjectName">—</div>
          <div class="text-gray-600 text-sm leading-relaxed" id="pInvNotes">—</div>
        </div>
      </div>
    </div>
    
    <!-- Items Table -->
    <div class="mb-8">
      <table class="w-full border-collapse text-sm">
        <thead>
          <tr>
            <th class="bg-gray-100 border border-gray-300 py-3 px-4 font-bold text-gray-800 text-right w-[50%]">{% trans "الخدمة / الوصف" %}</th>
            <th class="bg-gray-100 border border-gray-300 py-3 px-4 font-bold text-gray-800 text-center w-[12%]">{% trans "الكمية" %}</th>
            <th class="bg-gray-100 border border-gray-300 py-3 px-4 font-bold text-gray-800 text-left w-[19%]">{% trans "سعر الوحدة" %}</th>
            <th class="bg-gray-100 border border-gray-300 py-3 px-4 font-bold text-gray-800 text-left w-[19%]">{% trans "الإجمالي" %}</th>
          </tr>
        </thead>
        <tbody id="pItems"></tbody>
      </table>
    </div>
    
    <!-- Totals -->
    <div class="grid grid-cols-2 gap-y-3 ml-auto max-w-xs mb-8" style="grid-template-columns: 150px 1fr;">
      <div class="text-gray-600 font-medium text-left">{% trans "الإجمالي الفرعي" %}</div>
      <div class="text-gray-900 font-semibold text-left"><span id="pSubtotal">0</span> د.ل</div>
      <div class="text-gray-600 font-medium text-left">{% trans "خصم" %}</div>
      <div class="text-gray-900 font-semibold text-left">- <span id="pDiscount">0</span> د.ل</div>
      <div class="text-gray-600 font-medium text-left">{% trans "ضريبة" %}</div>
      <div class="text-gray-900 font-semibold text-left">+ <span id="pTax">0</span> د.ل</div>
      <div class="font-bold text-blue-600 text-base pt-3 mt-3 border-t border-gray-300">{% trans "الإجمالي النهائي" %}</div>
      <div class="font-bold text-blue-600 text-base pt-3 mt-3 border-t border-gray-300"><span id="pTotal">0</span> د.ل</div>
    </div>
    
    <!-- Payment Info -->
    <div class="mb-10">
      <h3 class="font-bold text-base text-gray-800 mb-3 pb-2 border-b border-gray-300">{% trans "بيانات الدفع" %}</h3>
      <div class="text-gray-600 text-sm leading-relaxed whitespace-pre-wrap" id="pPayInfo">—</div>
    </div>
    
    <!-- Footer -->
    <div class="text-center pt-8 mt-8 border-t border-gray-300">
      <div class="h-px bg-gradient-to-l from-transparent via-gray-400 to-transparent mb-4"></div>
      <div class="text-gray-500 text-xs leading-relaxed">
        {% trans "تم إصدار هذه الفاتورة إلكترونيًا ولا تتطلب توقيعًا." %}
        <br />
        {% trans "شكرًا لاختياركم SITEX." %}
      </div>
    </div>
  </div>
</section>

<style>
  @keyframes fadeIn {
    to { opacity: 1; }
  }
  
  /* Print Styles */
  @media print {
    @page {
      size: A4;
      margin: 20mm;
    }
    
    body * {
      visibility: hidden !important;
    }
    
    #printInvoice,
    #printInvoice * {
      visibility: visible !important;
    }
    
    #printInvoice {
      display: block !important;
      position: absolute !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: auto !important;
      background: white !important;
      padding: 0 !important;
      margin: 0 !important;
    }
    
    html, body {
      height: auto !important;
      overflow: visible !important;
      background: white !important;
    }
    
    /* Hide all non-print elements */
    .min-h-screen, .bg-gradient-to-br, button, .flex, .grid, .space-y-6, .mt-8, .gap-6 {
      display: none !important;
    }
  }
</style>


<!-- ================= ENHANCED SCRIPT ================= -->
<script>
  // ========= Templates for quick filling =========
  const INVOICE_TEMPLATES = {
    website: [
      { name: "تصميم وتطوير موقع ويب متجاوب", qty: 1, unit: 400, note: "تصميم عصري متكامل مع جميع الشاشات" },
      { name: "نطاق مخصص (دومين) لمدة سنة", qty: 1, unit: 30, note: "اسم النطاق حسب اختيار العميل" },
      { name: "استضافة مواقع لمدة 6 أشهر", qty: 1, unit: 150, note: "استضافة سحابية مع دعم فني" },
      { name: "شهادة SSL مجانية", qty: 1, unit: 0, note: "تشفير HTTPS للموقع" },
      { name: "إعداد بريد إلكتروني رسمي", qty: 3, unit: 50, note: "info@yourdomain.com" },
    ],
    ecommerce: [
      { name: "تصميم وتطوير متجر إلكتروني", qty: 1, unit: 600, note: "متجر كامل مع لوحة تحكم" },
      { name: "تكامل مع بوابة الدفع", qty: 1, unit: 200, note: "ربط مع نظام الدفع الإلكتروني" },
      { name: "إدارة المنتجات والطلبات", qty: 1, unit: 150, note: "لوحة تحكم كاملة للمنتجات" },
      { name: "تطبيق لوحة تحكم الموردين", qty: 1, unit: 100, note: "لإدارة المخزون والمبيعات" },
    ],
    maintenance: [
      { name: "صيانة شهرية للموقع", qty: 6, unit: 100, note: "تحديثات ودعم فني شهري" },
      { name: "نسخ احتياطي أسبوعي", qty: 1, unit: 50, note: "نسخ احتياطي تلقائي للبيانات" },
      { name: "مراقبة أمان الموقع", qty: 1, unit: 80, note: "حماية من الهجمات الإلكترونية" },
    ],
    custom: []
  };

  // ========= Default items =========
  let INV_ITEMS = [
    { name: "تصميم وتطوير موقع", qty: 1, unit: 0, note: "" },
  ];

  // ========= Utilities =========
  const fmt = (n) => new Intl.NumberFormat('ar-LY', {
    minimumFractionDigits: 0,
    maximumFractionDigits: 0
  }).format(Number(n || 0));

  function todayISO() {
    const d = new Date();
    const yyyy = d.getFullYear();
    const mm = String(d.getMonth() + 1).padStart(2, "0");
    const dd = String(d.getDate()).padStart(2, "0");
    return `${yyyy}-${mm}-${dd}`;
  }

  function generateInvoiceNumber() {
    const date = new Date();
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
    return `INV-${year}${month}-${random}`;
  }

  // ========= Render Items Table =========
  function renderItems() {
    const tbody = document.getElementById("invItemsBody");
    if (!INV_ITEMS.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center py-4 text-muted">
            <i class="fas fa-clipboard-list fa-2x mb-3 opacity-50"></i>
            <p class="mb-0">{% trans "لا توجد بنود مضافة" %}<br>
            <span class="small opacity-75">{% trans "انقر على 'إضافة بند' لبدء الفاتورة" %}</span></p>
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = INV_ITEMS.map((it, i) => {
      const total = Number(it.qty || 0) * Number(it.unit || 0);
      return `
        <tr class="service-row" data-idx="${i}">
          <td class="ps-4">
            <div class="d-flex align-items-start gap-2">
              <div class="mt-1">
                <span class="badge bg-primary bg-opacity-10 text-primary">${i + 1}</span>
              </div>
              <div class="flex-grow-1">
                <input class="form-control form-control-sm mb-2 inv-name"
                       value="${it.name || ""}"
                       placeholder="{% trans 'اسم الخدمة / الوصف' %}" />
                <textarea class="form-control form-control-sm inv-note"
                          rows="2"
                          placeholder="{% trans 'ملاحظات إضافية (اختياري)' %}">${it.note || ""}</textarea>
              </div>
            </div>
          </td>

          <td class="text-center">
            <div class="quantity-control d-flex align-items-center justify-content-center gap-2">
              <button class="btn btn-sm btn-outline-secondary qty-minus" type="button">
                <i class="fas fa-minus"></i>
              </button>
              <input class="form-control form-control-sm text-center inv-qty"
                     type="number"
                     min="1"
                     value="${it.qty || 1}"
                     style="width: 70px;" />
              <button class="btn btn-sm btn-outline-secondary qty-plus" type="button">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          </td>

          <td class="text-end">
            <div class="input-group input-group-sm">
              <input class="form-control text-end inv-unit"
                     type="number"
                     min="0"
                     value="${it.unit || 0}" />
              <span class="input-group-text">د.ل</span>
            </div>
          </td>

          <td class="text-end pe-4">
            <div class="fw-bold h6 mb-0">${fmt(total)} د.ل</div>
            <small class="text-muted">${fmt(it.unit)} × ${it.qty}</small>
          </td>

          <td class="text-center actions">
            <button class="btn btn-sm btn-outline-danger inv-del" type="button" title="{% trans 'حذف' %}">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      `;
    }).join("");
  }

  // ========= Calculate Totals =========
  function calcTotals() {
    const tbody = document.getElementById("invItemsBody");
    let subtotal = 0;

    [...tbody.querySelectorAll("tr.service-row")].forEach((tr, i) => {
      if (!tr.dataset.idx) return;

      const idx = i;
      const name = tr.querySelector(".inv-name")?.value || INV_ITEMS[idx]?.name || "";
      const note = tr.querySelector(".inv-note")?.value || "";
      let qty = Number(tr.querySelector(".inv-qty")?.value || 1);
      let unit = Number(tr.querySelector(".inv-unit")?.value || 0);

      if (!Number.isFinite(qty) || qty < 1) qty = 1;
      if (!Number.isFinite(unit) || unit < 0) unit = 0;

      INV_ITEMS[idx] = { name, note, qty, unit };

      const line = qty * unit;
      subtotal += line;

      // Update row total display
      const totalDisplay = tr.querySelector("td:nth-child(4) .h6");
      const calcDisplay = tr.querySelector("td:nth-child(4) small");
      if (totalDisplay) totalDisplay.textContent = `${fmt(line)} د.ل`;
      if (calcDisplay) calcDisplay.textContent = `${fmt(unit)} × ${qty}`;
    });

    const disc = Math.max(0, Number(document.getElementById("invDiscount").value || 0));
    const tax = Math.max(0, Number(document.getElementById("invTax").value || 0));
    const total = Math.max(0, subtotal - disc + tax);

    // Update totals display
    document.getElementById("invSubtotal").textContent = fmt(subtotal);
    document.getElementById("invTotal").textContent = fmt(total);
    document.getElementById("itemsCount").textContent = INV_ITEMS.length;

    // Update print preview
    updatePrintPreview(subtotal, disc, tax, total);
  }

  // ========= Update Print Preview =========
  function updatePrintPreview(subtotal, discount, tax, total) {
    // Update header info
    document.getElementById("pInvNumber").textContent = document.getElementById("invNumber").value || "—";
    document.getElementById("pInvDate").textContent = document.getElementById("invDate").value || "—";

    // Update client info
    document.getElementById("pClientName").textContent = document.getElementById("clientName").value || "—";
    document.getElementById("pClientCompany").textContent = document.getElementById("clientCompany").value || "—";
    document.getElementById("pClientEmail").textContent = document.getElementById("clientEmail").value || "—";
    document.getElementById("pClientPhone").textContent = document.getElementById("clientPhone").value || "—";

    // Update project info
    const projectTypeSelect = document.getElementById("projectType");
    const projectType = projectTypeSelect.options[projectTypeSelect.selectedIndex]?.text || "—";
    document.getElementById("pProjectType").textContent = projectType;
    document.getElementById("pProjectName").textContent = document.getElementById("projectName").value || "—";
    document.getElementById("pInvNotes").textContent = document.getElementById("invNotes").value || "—";

    // Update payment info
    document.getElementById("pPayInfo").textContent = document.getElementById("invPayInfo").value || "—";

    // Update totals
    document.getElementById("pSubtotal").textContent = fmt(subtotal);
    document.getElementById("pDiscount").textContent = fmt(discount);
    document.getElementById("pTax").textContent = fmt(tax);
    document.getElementById("pTotal").textContent = fmt(total);

    // Update items in print preview
    const pItemsTbody = document.getElementById("pItems");
    pItemsTbody.innerHTML = INV_ITEMS.map((item, i) => {
      const itemTotal = item.qty * item.unit;
      return `
        <tr>
          <td>
            <div class="item-description">${item.name || "—"}</div>
            ${item.note ? `<div class="item-note">${item.note}</div>` : ''}
          </td>
          <td style="text-align:center">${item.qty}</td>
          <td style="text-align:end">${fmt(item.unit)} د.ل</td>
          <td style="text-align:end">${fmt(itemTotal)} د.ل</td>
        </tr>
      `;
    }).join("") || `
      <tr>
        <td colspan="4" style="text-align:center; padding:20px; color:#999">
          {% trans "لا توجد بنود" %}
        </td>
      </tr>
    `;
  }

  // ========= Add/Remove Items =========
  function addRow() {
    INV_ITEMS.push({ name: "", qty: 1, unit: 0, note: "" });
    renderItems();
    bindTableEvents();
    calcTotals();
  }

  function clearAllItems() {
    if (confirm("{% trans 'هل أنت متأكد من حذف جميع البنود؟' %}")) {
      INV_ITEMS = [];
      renderItems();
      calcTotals();
    }
  }

  // ========= Template Functions =========
  function loadTemplate(templateName) {
    if (!INVOICE_TEMPLATES[templateName]) return;

    if (templateName === 'custom') {
      // For custom, just add empty row
      INV_ITEMS = [{ name: "", qty: 1, unit: 0, note: "" }];
    } else {
      INV_ITEMS = [...INVOICE_TEMPLATES[templateName]];
    }

    renderItems();
    bindTableEvents();
    calcTotals();

    // Show success message
    showToast(`تم تحميل قالب ${templateName}`, 'success');
  }

  // ========= Event Binding =========
  function bindTableEvents() {
    const tbody = document.getElementById("invItemsBody");

    // Input changes
    tbody.addEventListener("input", (e) => {
      if (e.target.classList.contains("inv-name") ||
          e.target.classList.contains("inv-note") ||
          e.target.classList.contains("inv-qty") ||
          e.target.classList.contains("inv-unit")) {
        calcTotals();
      }
    });

    // Quantity buttons
    tbody.addEventListener("click", (e) => {
      const btn = e.target.closest(".qty-minus, .qty-plus");
      if (btn) {
        const tr = btn.closest("tr");
        const qtyInput = tr.querySelector(".inv-qty");
        let qty = parseInt(qtyInput.value) || 1;

        if (btn.classList.contains("qty-minus") && qty > 1) {
          qty--;
        } else if (btn.classList.contains("qty-plus")) {
          qty++;
        }

        qtyInput.value = qty;
        calcTotals();
      }
    });

    // Delete buttons
    tbody.addEventListener("click", (e) => {
      const btn = e.target.closest(".inv-del");
      if (btn) {
        const tr = btn.closest("tr");
        const idx = parseInt(tr.dataset.idx);

        if (confirm("{% trans 'هل أنت متأكد من حذف هذا البند؟' %}")) {
          INV_ITEMS.splice(idx, 1);
          renderItems();
          bindTableEvents();
          calcTotals();
        }
      }
    });
  }

  // ========= Utility Functions =========
  function showToast(message, type = 'info') {
    // Create toast element
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-bg-${type} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');

    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${message}</div>
        <button type="button" class="btn-close btn-close-white mx-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    `;

    // Add to container
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.appendChild(toast);
    document.body.appendChild(container);

    // Show and auto-remove
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();

    toast.addEventListener('hidden.bs.toast', () => {
      container.remove();
    });
  }

  async function copySummary() {
    const invoiceNo = document.getElementById("invNumber").value || "—";
    const invoiceDate = document.getElementById("invDate").value || "—";
    const client = document.getElementById("clientName").value || "—";
    const subtotal = document.getElementById("invSubtotal").textContent;
    const total = document.getElementById("invTotal").textContent;

    const lines = INV_ITEMS.map((x, i) =>
      `${i + 1}. ${x.name} | الكمية: ${x.qty} | السعر: ${fmt(x.unit)} | الإجمالي: ${fmt(x.qty * x.unit)} د.ل`
    ).join("\n");

    const text =
`فاتورة SITEX
رقم الفاتورة: ${invoiceNo}
التاريخ: ${invoiceDate}
العميل: ${client}

البنود:
${lines || "—"}

الإجمالي الفرعي: ${subtotal} د.ل
الإجمالي النهائي: ${total} د.ل
`;

    try {
      await navigator.clipboard.writeText(text);
      showToast("تم نسخ ملخص الفاتورة بنجاح", "success");
    } catch (e) {
      prompt("انسخ النص أدناه:", text);
    }
  }

  function saveDraft() {
    const draft = {
      invoiceNumber: document.getElementById("invNumber").value,
      invoiceDate: document.getElementById("invDate").value,
      client: {
        name: document.getElementById("clientName").value,
        company: document.getElementById("clientCompany").value,
        email: document.getElementById("clientEmail").value,
        phone: document.getElementById("clientPhone").value,
      },
      project: {
        type: document.getElementById("projectType").value,
        name: document.getElementById("projectName").value,
        notes: document.getElementById("invNotes").value,
      },
      items: INV_ITEMS,
      totals: {
        subtotal: document.getElementById("invSubtotal").textContent,
        discount: document.getElementById("invDiscount").value,
        tax: document.getElementById("invTax").value,
        total: document.getElementById("invTotal").textContent,
      },
      paymentInfo: document.getElementById("invPayInfo").value,
      lastSaved: new Date().toISOString(),
    };

    localStorage.setItem('sitex_invoice_draft', JSON.stringify(draft));
    showToast("تم حفظ الفاتورة كمسودة", "success");
  }

  function loadDraft() {
    const saved = localStorage.getItem('sitex_invoice_draft');
    if (saved) {
      try {
        const draft = JSON.parse(saved);

        // Load basic info
        document.getElementById("invNumber").value = draft.invoiceNumber || "";
        document.getElementById("invDate").value = draft.invoiceDate || "";

        // Load client info
        document.getElementById("clientName").value = draft.client?.name || "";
        document.getElementById("clientCompany").value = draft.client?.company || "";
        document.getElementById("clientEmail").value = draft.client?.email || "";
        document.getElementById("clientPhone").value = draft.client?.phone || "";

        // Load project info
        document.getElementById("projectType").value = draft.project?.type || "";
        document.getElementById("projectName").value = draft.project?.name || "";
        document.getElementById("invNotes").value = draft.project?.notes || "";

        // Load items
        INV_ITEMS = draft.items || [];

        // Load totals
        document.getElementById("invDiscount").value = draft.totals?.discount || 0;
        document.getElementById("invTax").value = draft.totals?.tax || 0;

        // Load payment info
        document.getElementById("invPayInfo").value = draft.paymentInfo || "";

        // Re-render and calculate
        renderItems();
        bindTableEvents();
        calcTotals();

        showToast("تم تحميل المسودة المحفوظة", "info");
      } catch (e) {
        console.error("Error loading draft:", e);
      }
    }
  }

  // ========= Initialize =========
  document.addEventListener("DOMContentLoaded", () => {
    // Set default date
    const invDate = document.getElementById("invDate");
    if (invDate && !invDate.value) {
      invDate.value = todayISO();
    }

    // Generate invoice number if empty
    const invNumber = document.getElementById("invNumber");
    if (invNumber && !invNumber.value) {
      invNumber.value = generateInvoiceNumber();
    }

    // Initial render
    renderItems();
    bindTableEvents();
    calcTotals();

    // Load draft if exists
    loadDraft();

    // Bind buttons
    document.getElementById("addRowBtn").addEventListener("click", addRow);
    document.getElementById("clearAllBtn").addEventListener("click", clearAllItems);
    document.getElementById("invDiscount").addEventListener("input", calcTotals);
    document.getElementById("invTax").addEventListener("input", calcTotals);

    // Bind template buttons
    document.querySelectorAll(".template-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        loadTemplate(btn.dataset.template);
      });
    });

    // Bind action buttons
    document.getElementById("saveDraftBtn").addEventListener("click", saveDraft);
    document.getElementById("printBtn").addEventListener("click", () => {
      calcTotals(); // Ensure print values are updated
      setTimeout(() => window.print(), 100);
    });
    document.getElementById("copyBtn").addEventListener("click", copySummary);
    document.getElementById("sendEmailBtn").addEventListener("click", () => {
      alert("سيتم إضافة إرسال البريد الإلكتروني في نسخة لاحقة");
    });

    // Auto-save on input (with debounce)
    let saveTimeout;
    const autoSaveElements = [
      "invNumber", "invDate", "clientName", "clientCompany",
      "clientEmail", "clientPhone", "projectType", "projectName",
      "invNotes", "invDiscount", "invTax", "invPayInfo"
    ];

    autoSaveElements.forEach(id => {
      const el = document.getElementById(id);
      if (el) {
        el.addEventListener("input", () => {
          clearTimeout(saveTimeout);
          saveTimeout = setTimeout(() => {
            calcTotals();
          }, 500);
        });
      }
    });
  });
</script>

{% endblock %}